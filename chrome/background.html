<!--
 - 'Missing e' Extension
 -
 - Copyright 2011, Jeremy Cutler
 - Released under the GPL version 3 licence.
 - SEE: license/GPL-LICENSE.txt
 -
 - This file is part of 'Missing e'.
 -
 - 'Missing e' is free software: you can redistribute it and/or modify
 - it under the terms of the GNU General Public License as published by
 - the Free Software Foundation, either version 3 of the License, or
 - (at your option) any later version.
 -
 - 'Missing e' is distributed in the hope that it will be useful,
 - but WITHOUT ANY WARRANTY; without even the implied warranty of
 - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 - GNU General Public License for more details.
 -
 - You should have received a copy of the GNU General Public License
 - along with 'Missing e'.  If not, see [http://www.gnu.org/licenses/].
-->
<html>
<head>
<script type="text/javascript">
var MissingE = {};
</script>
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="core/utils.js"></script>
<script type="text/javascript" src="core/localizations.js"></script>
<script>
var currVersion;
var maxActiveAjax = 15;
var activeAjax = 0;
var activeRequests = {};
var waitQueue = [];
var onHold = {};
var numSleeping = 0;
var cache = {};
var cacheElements = 0;
var cacheClear;
var clearQueues;
var permissionCache = {};
var askerTable = {};
var askerWaiters = {};
var askerTableCopy = {};
var askerTableClear;
var fiveMinutes = 300000;
var tenSeconds = 10000;
var debugMode = false;
var tabs = {};
var replies = {};
var crushes = {};
var repliesAndCrushesClear;
var lang = 'en';

function getSetting(key, defVal) {
   var retval = localStorage[key];
   if (retval === undefined || retval === null || retval === "") {
      return defVal;
   }
   else {
      if (/[^\d]/.test(retval)) {
         return retval;
      }
      else {
         return parseInt(retval, 10);
      }
   }
}

function setSetting(key, val) {
   localStorage[key] = val;
}

function getVersion() {
   var xhr = new XMLHttpRequest();
   xhr.open('GET', chrome.extension.getURL('manifest.json'), false);
   xhr.send(null);
   var manifest = JSON.parse(xhr.responseText);
   return manifest.version;
}

function addTab(id, url) {
   var d = (new Date()).valueOf();
   tabs[id] = d;
   debug("Adding tab (" + id + ") " + d);
}

chrome.tabs.onRemoved.addListener(function(id, removeInfo) {
   if (tabs[id]) {
      delete tabs[id];
      debug("Removing tab (" + id + ")");
   }
});

repliesAndCrushesClear = setInterval(function() {
   var i;
   for (i in replies) {
      if (replies.hasOwnProperty(i)) {
         if (!tabs.hasOwnProperty(i)) {
            delete replies[i];
         }
      }
   }
   for (i in crushes) {
      if (crushes.hasOwnProperty(i)) {
         if (!tabs.hasOwnProperty(i)) {
            delete crushes[i];
         }
      }
   }
}, fiveMinutes);

askerTableClear = setInterval(function() {
   var i;
   for (i in askerTableCopy) {
      if (askerTableCopy.hasOwnProperty(i) &&
          askerTable.hasOwnProperty(i)) {
         delete askerTable[i];
      }
   }
   askerTableCopy = {};
   for (i in askerTable) {
      if (askerTable.hasOwnProperty(i)) {
         askerTableCopy[i] = true;
      }
   }
}, fiveMinutes);

cacheClear = setInterval(function() {
   cache = {};
   cacheElements = 0;
   permissionCache = {};
}, fiveMinutes);

clearQueues = setInterval(function() {
   if (activeAjax == 0) {
      if (numSleeping !== 0) {
         debug(numSleeping + " still sleeping");
      }
      if (waitQueue.length > 0) {
         debug(waitQueue.length + " still queued");
      }
   }
}, tenSeconds);

function debug(msg) {
   if (debugMode) {
      console.log(msg);
   }
}

function versionCompare(v1, v2) {
   if (!v1 && !v2) { return 0; }
   else if (!v1) { return -1; }
   else if (!v2) { return 1; }
   else {
      var i;
      var ver1 = v1.split('.');
      var ver2 = v2.split('.');
      var len = ver1.length >= ver2.length ? ver1.length : ver2.length;
      for (i=0; i<len; i++) {
         if (i >= ver1.length && ver2[i] !== '0') { return -1; }
         else if (i >= ver2.length && ver1[i] !== '0') { return 1; }
         else {
            ver1[i] = parseInt(ver1[i]);
            ver2[i] = parseInt(ver2[i]);
         }
         if (ver1[i] > ver2[i]) { return 1; }
         if (ver2[i] > ver1[i]) { return -1; }
      }
      return 0;
   }
}

function closeTab(url, currentId) {
   chrome.windows.getAll({populate: true},
                         function (windows) {
      var i,j;
      for (i=0; i<windows.length; i++) {
         for (j=0; j<windows[i].tabs.length; j++) {
            if (windows[i].tabs[j].url == url &&
                windows[i].tabs[j].id != currentId) {
               chrome.tabs.remove(windows[i].tabs[j].id);
            }
         }
      }
   });
}

function isInternalSetting(setting) {
   return !/^MissingE_/.test(setting) ||
          setting === "MissingE_version" ||
          /MissingE_externalVersion/.test(setting) ||
          setting === "MissingE_compatCheck" ||
          !/^\w*$/.test(setting);
}

function createOptionParams() {
   var opts = {};
   for (setting in localStorage) {
      if (localStorage.hasOwnProperty(setting) &&
          !isInternalSetting(setting)) {
         opts[setting] = localStorage[setting];
      }
   }
   return opts;
}

function receiveOptions(request, sendResponse) {
   var changed, set, reset;
   changed = set = reset = 0;
   var settings = request.data;
   for (i in settings) {
      if (settings.hasOwnProperty(i)) {
         if (!localStorage.hasOwnProperty(i) ||
             localStorage[i] !== settings[i]) {
            var old = "'" + localStorage[i] + "'";
            if (localStorage[i] === undefined) {
               old = "undefined";
               set++;
            }
            else {
               changed++;
            }
            debug(i + " [" + old + " => '" +
                        settings[i] + "']");
            localStorage[i] = settings[i];
         }
      }
   }
   for (i in localStorage) {
      if (localStorage.hasOwnProperty(i) &&
          !settings.hasOwnProperty(i) &&
          !isInternalSetting(i)) {
         reset++;
         localStorage.removeItem(i);
      }
   }
   if (set + changed + reset > 0) {
      fixupSettings();
      alert("Import complete.\n\n" + (set+changed+reset) + " change(s) made.");
      sendResponse({greeting:"importOptions", success:true});
   }
   else {
      alert("No changes imported.");
      sendResponse({greeting:"importOptions", success:false});
   }
}

function doTags(stamp, id, sendResponse) {
   if (!stamp.tags) {
      debug("Cache entry does not have tags");
      return false;
   }
   var tags = stamp.tags;
   if (!tags) {
      tags = [];
   }
   sendResponse({success: true, data: tags});
}

function doTimestamp(stamp, id, sendResponse) {
   if (!stamp.timestamp) {
      debug("Cache entry does not have timestamp");
      return false;
   }
   var ts = stamp.timestamp;
   var d = new Date(ts*1000);
   if (isNaN(d)) {
      sendResponse({pid: id, success: false});
   }
   var ins = getSetting("MissingE_timestamps_format",MissingE.defaultFormat);
   ins = MissingE.getFormattedDate(d, ins, lang);
   ins = ins.replace(/%X/g,id);
   sendResponse({pid: id, success: true, data: ins});
   return true;
}

function doReblogDash(stamp, id, sendResponse) {
   if (!stamp.reblog_key) {
      debug("Cache entry does not have reblog key.");
      return false;
   }
   var key = stamp.reblog_key;
   var name = stamp.name;
   var replaceIcons = getSetting("MissingE_dashboardTweaks_enabled",1) == 1 &&
                      getSetting("MissingE_dashboardTweaks_replaceIcons",1) == 1;
   sendResponse({pid: id, success: true, data: key, name: name, icons: replaceIcons});
   return true;
}

function queueAjax(details) {
   waitQueue.push(details);
   debug("Queueing " + details.type + " request. " + (waitQueue.length) + " in queue");
}

function dequeueAjax(id) {
   if (id) {
      activeAjax--;
      wakeById(id);
      delete activeRequests[id];
   }
   while (activeAjax < maxActiveAjax) {
      var call = waitQueue.shift();
      if (!call) { return false; }
      debug("Dequeueing " + call.type + " request. " + (waitQueue.length) + " in queue");
      runItem(call);
   }
}

function saveCache(id, entry) {
   var theEntry;
   var isNew = true;
   if ((theEntry = cache[id])) {
      debug("Saving " + id + " to cache (HIT)");
      isNew = false;
   }
   else {
      debug("Saving " + id + " to cache (MISS)");
      cacheElements++;
      theEntry = {};
   }
   for (var i in entry) {
      if (entry.hasOwnProperty(i)) {
         if (i == "photos" ||
             i == "timestamp" ||
             i == "reblog_key" ||
             i == "post_url" ||
             i == "tags" ||
             i == "type" ||
             (i == "name" && entry[i] != "")) {
            theEntry[i] = entry[i];
         }
      }
   }
   if (isNew) {
      cache[id] = theEntry;
   }
}

function cacheServe(type, id, sendResponse, fn, midFlight, notAjax) {
   var entry;
   if ((entry = cache[id])) {
      debug(type + " request (" + id + ") has cache entry.");
      if (midFlight && !notAjax) {
         dequeueAjax(id);
      }
      else if (!notAjax) {
         dequeueAjax();
      }
      return fn(entry, id, sendResponse);
   }
   else {
      return false;
   }
}

function runItem(call) {
   if (call.type === "reblogYourself") {
      requestReblogYourself(call.request, call.sender, call.sendResponse, call.hash);
   }
   else if (call.type === "betterReblogs") {
      requestBetterReblogsAsk(call.request, call.sender, call.sendResponse, call.hash);
   }
   else if (call.type === "timestamp") {
      requestTimestamp(call.request, call.sender, call.sendResponse, call.hash);
   }
   else if (call.type === "tags") {
      requestTags(call.request, call.sender, call.sendResponse, call.hash);
   }
}

function wakeById(id) {
   var i,j;
   for (i=0; activeRequests[id] && i<activeRequests[id].length; i++) {
      var call;
      if ((call = activeRequests[id][i])) {
         delete onHold[call.type + call.request.pid];
         numSleeping--;
         debug("Selectively waking " + call.type + " request (" + call.request.pid + "). " + numSleeping + " still asleep");
         runItem(call);
      }
   }
}

function isRequested(details) {
   var bucket;
   if (!details.request.sleepCount) {
      details.request.sleepCount = 0;
   }
   if ((bucket = activeRequests[details.request.pid]) &&
       details.request.sleepCount < 5) {
      onHold[details.type + details.request.pid] = details;
      bucket.push(details);
      numSleeping++;
      details.request.sleepCount++;
      debug("Sleeping " + details.type + " request (" + details.request.pid +
            ") [" + details.request.sleepCount + "]. " + numSleeping +
            " asleep");
      return true;
   }
   else {
      return false;
   }
}

function startAjax(id) {
   activeAjax++;
   if (!activeRequests.hasOwnProperty(id)) {
      activeRequests[id] = [];
   }
}

function doAskAjax(request, sender, sendResponse, hash, retries, type, doFunc) {
   debug("AJAX " + type + " request (" + request.pid + ")");
   startAjax(request.pid);
   var failMsg = {greeting:type, success:false, pid:request.pid};
   $.ajax({
      type: "GET",
      url: request.url + request.pid,
      dataType: "html",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.pid,
      tabId: sender.tab.id,
      tabHash: hash,
      error: function(xhr, textStatus) {
         if (xhr.status == 404) {
            debug(type + " request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            sendResponse(failMsg);
            return;
         }
         if (this.tabHash !== tabs[this.tabId]) {
            debug("Stop " + type + " request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         if (cacheServe(type, request.pid, sendResponse, doFunc, true)) {
            return true;
         }
         else {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               debug("Retry " + type + " request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               sendResponse(failMsg);
            }
         }
      },
      success: function(data, textStatus) {
         var closed = (this.tabHash !== tabs[this.tabId]);
         if (!(/<input[^>]*name="post\[date\]"[^>]*>/.test(data))) {
            if (closed) {
               debug("Stop " + type + " request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe(type, request.pid, sendResponse, doFunc, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  debug("Retry " + type + " request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  debug(type + " request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  sendResponse(failMsg);
               }
            }
         }
         else {
            var failed = false;
            var txt;
            var inp = data.match(/<input[^>]*name="post\[date\]"[^>]*>/);
            if (!inp) { failed = true; }
            else {
               txt = inp[0].match(/value="([^"]*)"/);
               if (!txt || txt.length < 2) {
                  failed = true;
               }
               else {
                  txt = txt[1];
               }
            }
            if (failed) {
               debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               sendResponse(failMsg);
               return;
            }
            var m = txt.match(/([A-Za-z]+) (\d+)[^,]*, (\d+) (\d+):(\d+)([aApP][mM])/);
            var d = new Date(m[1] + ' ' + m[2] + ', ' + m[3] + ' ' +
                             (m[6]=='pm' && m[4] !== '12' ? parseInt(m[4])+12 : m[4]) +
                             ':' + m[5] + ':00 GMT');
            var stamp = Math.round(d.getTime()/1000);
            var info = {"timestamp":stamp};
            saveCache(this.targetId, info);
            dequeueAjax(this.targetId);
            if (!closed) {
               doFunc(info, this.targetId, sendResponse);
            }
         }
      }
   });
}

function checkPermission(request, sender, sendResponse, hash, retries, tryCount) {
   if (permissionCache.hasOwnProperty(request.user)) {
      sendResponse({allow: permissionCache[request.user]});
      return;
   }
   var ajax = new XMLHttpRequest();
   ajax.open("HEAD", "http://www.tumblr.com/blog/" + request.user, true);
   ajax.tabHash = hash;
   ajax.tabId = sender.tab.id;
   if (!tryCount) { tryCount = 0; }
   ajax.onreadystatechange = function() {
      if (this.tabHash !== tabs[this.tabId]) {
         return;
      }
      else if (this.readyState == 4) {
         if (this.status == 200) {
            permissionCache[request.user] = true;
            sendResponse({allow: true});
         }
         else if (this.status < 500) {
            permissionCache[request.user] = false;
            sendResponse({allow:false});
         }
         else {
            tryCount++;
            if (tryCount <= retries) {
               checkPermission(request, sender, sendResponse, hash, retries,
                               tryCount);
               return;
            }
            else {
               sendResponse({allow:false});
            }
         }
      }
   };
   ajax.send();
}

function doTagsAjax(request, sender, sendResponse, hash, retries) {
   debug("AJAX tags request (" + request.pid + ")");
   startAjax(request.pid);
   var failMsg = {greeting:"tags", success:false, pid:request.pid};
   $.ajax({
      type: "GET",
      url: request.url + "/post/" + request.pid + "/rss",
      dataType: "html",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.pid,
      tabId: sender.tab.id,
      tabHash: hash,
      error: function(xhr, textStatus) {
         if (xhr.status === 404) {
            debug("tags request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            sendResponse(failMsg);
            return;
         }
         if (this.tabHash !== tabs[this.tabId]) {
            debug("Stop tags request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         if (cacheServe("tags", request.pid, sendResponse, doTags, true)) {
            return true;
         }
         else {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               debug("Retry tags request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               debug("tags request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               sendResponse(failMsg);
            }
         }
      },
      success: function(data, textStatus) {
         var closed = (this.tabHash !== tabs[this.tabId]);
         if (!(/<guid>[^<]*<\/guid>/.test(data))) {
            if (closed) {
               debug("Stop tags request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe("tags", request.pid, sendResponse, doTags, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  debug("Retry tags request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  debug("tags request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  sendResponse(failMsg);
               }
            }
         }
         else {
            var i;
            var tags = data.match(/<category>[^<]*<\/category>/g);
            if (!tags) { tags = []; }
            for (i=0; i<tags.length; i++) {
               tags[i] = tags[i].replace(/^<category>/,'')
                              .replace(/<\/category>$/,'');
            }
            var info = {"tags":tags};
            saveCache(this.targetId, info);
            dequeueAjax(this.targetId);
            if (!closed) {
               doTags(info, this.targetId, sendResponse);
            }
         }
      }
   });
}

function doReblogAjax(type, request, sender, sendResponse, hash, retries,
                              additional) {
   debug("AJAX " + type + " request (" + request.pid + ")");
   startAjax(request.pid);
   var failMsg = {greeting:type, success:false, pid:request.pid};
   if (additional) {
      for (i in additional) {
         if (additional.hasOwnProperty(i)) {
            failMsg[i] = additional[i];
         }
      }
   }
   $.ajax({
      type: "GET",
      url: request.url,
      dataType: "html",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.pid,
      tabId: sender.tab.id,
      tabHash: hash,
      error: function(xhr, textStatus) {
         if (xhr.status === 404) {
            debug(type + " request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            sendResponse(failMsg);
            return;
         }
         if (this.tabHash !== tabs[this.tabId]) {
            debug("Stop " + type + " request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         if (cacheServe(type, request.pid, sendResponse, doReblogDash, true)) {
            return true;
         }
         else {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               debug("Retry " + type + " request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               sendResponse(failMsg);
            }
         }
      },
      success: function(data, textStatus) {
         var closed = (this.tabHash !== tabs[this.tabId]);
         var ifr = data.match(/<\s*iframe[^>]*id="tumblr_controls"[^>]*>/);
         if (!ifr || ifr.length === 0) {
            if (closed) {
               debug("Stop " + type + " request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe(type, request.pid, sendResponse, doReblogDash, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  debug("Retry " + type + " request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  debug(type + " request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  sendResponse(failMsg);
               }
            }
         }
         else {
            var rk = ifr[0].match(/rk=([^&"']*)/);
            var poster = ifr[0].match(/name=([^&"']*)/);
            var user;
            if (rk && rk.length > 1) {
               if (!poster || poster.length <= 1) {
                  user = "";
               }
               else {
                  user = poster[1];
               }
               var info = {"reblog_key":rk[1],
                           "name":user};
               saveCache(this.targetId, info);
               dequeueAjax(this.targetId);
               if (!closed) {
                  doReblogDash(info, this.targetId, sendResponse);
               }
            }
            else if (!closed) {
               debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               sendResponse(failMsg);
            }
         }
      }
   });
}

function requestBetterReblogsAsk(request, sender, sendResponse, hash) {
   if (hash !== tabs[sender.tab.id]) {
      debug("Stop betterReblogs request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("betterReblogs", request.pid, sendResponse, doReblogDash, false)) {
      return true;
   }
   else if (isRequested({type: "betterReblogs", request: request, sender: sender, sendResponse: sendResponse, hash: hash})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "betterReblogs", request: request, sender: sender, sendResponse: sendResponse, hash: hash});
   }
   else {
      doReblogAjax("betterReblogs", request, sender, sendResponse, hash,
             getSetting("MissingE_betterReblogs_askRetries",MissingE.defaultRetries),
             {
               pid:request.pid,
               icons:getSetting("MissingE_dashboardTweaks_enabled",1) == 1 &&
                     getSetting("MissingE_dashboardTweaks_replaceIcons",1) == 1
             });
   }
}

function requestReblogYourself(request, sender, sendResponse, hash) {
   if (hash !== tabs[sender.tab.id]) {
      debug("Stop reblogYourself request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("reblogYourself", request.pid, sendResponse, doReblogDash, false)) {
      return true;
   }
   else if (isRequested({type: "reblogYourself", request: request, sender: sender, sendResponse: sendResponse, hash: hash})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "reblogYourself", request: request, sender: sender, sendResponse: sendResponse, hash: hash});
   }
   else {
      doReblogAjax("reblogYourself", request, sender, sendResponse, hash,
             getSetting("MissingE_reblogYourself_retries",MissingE.defaultRetries),
             {
               pid:request.pid,
               icons:getSetting("MissingE_dashboardTweaks_enabled",1) == 1 &&
                     getSetting("MissingE_dashboardTweaks_replaceIcons",1) == 1
             });
   }
}

function requestTimestamp(request, sender, sendResponse, hash) {
   if (request.lang) { lang = request.lang; }
   if (hash !== tabs[sender.tab.id]) {
      debug("Stop timestamp request: Tab closed or changed.");
      dequeueAjax();
      return false;
   }
   else if (cacheServe("timestamp", request.pid, sendResponse, doTimestamp, false)) {
      return true;
   }
   else if (isRequested({type: "timestamp", request: request, sender: sender, sendResponse: sendResponse, hash: hash})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "timestamp", request: request, sender: sender, sendResponse: sendResponse, hash: hash});
   }
   else if (request.url === 'http://www.tumblr.com/edit/') {
      doAskAjax(request, sender, sendResponse, hash,
                getSetting("MissingE_timestamps_retries",MissingE.defaultRetries),
                "timestamp", doTimestamp);
   }
   else {
      doAjax(request, sender, sendResponse, hash,
             getSetting("MissingE_timestamps_retries",MissingE.defaultRetries),
             "timestamp", doTimestamp,
             {pid: request.pid, debugMode: debugMode});
   }
}

function requestTags(request, sender, sendResponse, hash) {
   if (hash !== tabs[sender.tab.id]) {
      debug("Stop tags request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("tags", request.pid, sendResponse, doTags, false)) {
      return true;
   }
   else if (isRequested({type: "tags", request: request, sender: sender, sendResponse: sendResponse, hash: hash})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "tags", request: request, sender: sender, sendResponse: sendResponse, hash: hash});
   }
   else {
      doTagsAjax(request, sender, sendResponse, hash,
                 getSetting("MissingE_betterReblogs_retries",MissingE.defaultRetries));
   }
}

function requestMagnifier(request, sender, sendResponse, hash) {
   if (hash !== tabs[sender.tab.id]) {
      debug("Stop magnifier request: Tab closed or changed.");
      return;
   }
   else {
      debug("Building magnifier request (" + request.pid + ")");
      var i,url;
      if (request.num > 1) {
         url = [];
         for (i=0; i<request.num; i++) {
            url.push("http://www.tumblr.com/photo/1280/" + request.pid + "/" +
                     request.revs[i] + "/" + request.code);
            url.push(request.captions[i]);
         }
         url = JSON.stringify(url);
      }
      else {
         url = "http://www.tumblr.com/photo/1280/" + request.pid + "/" +
            request.revs[0] + "/" + request.code;
      }
      sendResponse({pid: request.pid, success: true, data: url});
   }
}

function loadUI(tabId, uiType) {
   if (uiType === "core") {
      chrome.tabs.executeScript(tabId, {file: "lib/jquery.ui.core.min.js"});
      chrome.tabs.executeScript(tabId, {file: "lib/jquery.ui.widget.min.js"});
      chrome.tabs.executeScript(tabId, {file: "lib/jquery.ui.mouse.min.js"});
   }
   else if (uiType === "draggable") {
      chrome.tabs.executeScript(tabId, {file: "lib/jquery.ui.draggable.min.js"});
   }
   else if (uiType === "sortable") {
      chrome.tabs.executeScript(tabId, {file: "lib/jquery.ui.sortable.min.js"});
   }
   else if (uiType === "resizable") {
      chrome.tabs.executeScript(tabId, {file: "lib/jquery.ui.resizable.min.js"});
   }
}

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
   if (!sender.tab) sendResponse({});
   else if (request.greeting == "version") {
      sendResponse({uptodate:versionCompare(getSetting("MissingE_version",'0'),
                                            request.v) >= 0});
   }
   else if (request.greeting == "postMessage") {
      alert(request.text);
   }
   else if (request.greeting == "exportOptions") {
      sendResponse({greeting: "exportOptions", url: "http://tools.missinge.infraware.ca/settings?" + $.param(createOptionParams())});
   }
   else if (request.greeting == "importOptions") {
      receiveOptions(request, sendResponse);
   }
   else if (request.greeting == "getAsker") {
      if (askerTable[sender.tab.url]) {
         debug("Found saved asker for '" + sender.tab.url + "'");
         var name = askerTable[sender.tab.url].asker;
         var isSure = askerTable[sender.tab.url].isSure;
         if (--askerTable[sender.tab.url].count == 0) {
            debug("Deleting saved asker for '" + sender.tab.url + "'");
            delete askerTable[sender.tab.url];
         }
         if (name && name !== "") {
            sendResponse({name: name, isSure: isSure, url: sender.tab.url});
         }
      }
      else {
         if (askerWaiters[sender.tab.url]) {
            debug("Creating new askerWaiter for '" + sender.tab.url + "'");
            askerWaiters[sender.tab.url].push(sendResponse);
         }
         else {
            debug("Adding askerWaiter for '" + sender.tab.url + "'");
            askerWaiters[sender.tab.url] = [sendResponse];
         }
      }
   }
   else if (request.greeting == "sendAsker") {
      if (askerWaiters[sender.tab.url]) {
         debug("Found existing askerWaiter for '" + sender.tab.url + "'");
         var callback = askerWaiters[sender.tab.url].pop();
         if (askerWaiters[sender.tab.url].length === 0) {
            debug("Deleting existing askerWaiter queue for '" + sender.tab.url + "'");
            delete askerWaiters[sender.tab.url];
         }
         if (request.name && request.name !== "") {
            callback({name: request.name, isSure: request.isSure, url: sender.tab.url});
         }
      }
      else {
         if (askerTable[sender.tab.url]) {
            debug("Found existing askerTable entry for '" + sender.tab.url + "'");
            askerTable[sender.tab.url].count++;
         }
         else {
            debug("Creating askerTable entry for '" + sender.tab.url + "'");
            askerTable[sender.tab.url] = {asker: request.name,
                                          isSure: request.isSure, count:1};
         }
      }
   }
   else if (request.greeting == "uploader") {
      $.ajax({
         url:"http://www.tumblr.com/upload/image",
         dataType:"html",
         retries:4,
         tryCount:0,
         success:function(data) {
            var key = data.match(/<input[^>]*name="form_key"[^>]*value="([^"]*)"[^>]*>/);
            if (!key || key.length < 2) {
               if (this.tryCount < this.retries) {
                  this.tryCount++;
                  $.ajax(this);
               }
               else {
                  sendResponse({greeting: "uploader", success: false});
               }
            }
            else {
               sendResponse({greeting: "uploader", success: true, data: key[1]});
            }
         },
         error:function() {
            if (this.tryCount < this.retries) {
               this.tryCount++;
               $.ajax(this);
            }
            else {
               sendResponse({greeting: "uploader", success: false});
            }
         }
      });
   }
   else if (request.greeting == "update") {
      sendResponse({update:
         versionCompare(getSetting("MissingE_externalVersion",'0'),
                        getSetting("MissingE_version",'0')) > 0});
   }
   else if (request.greeting == "close-options") {
      closeTab(chrome.extension.getURL('core/options.html'), sender.tab.id);
   }
   else if (request.greeting == "magnifier") {
      requestMagnifier(request, sender, sendResponse, tabs[sender.tab.id]);
   }
   else if (request.greeting == "reblogYourself") {
      requestReblogYourself(request, sender, sendResponse, tabs[sender.tab.id]);
   }
   else if (request.greeting == "betterReblogs") {
      requestBetterReblogsAsk(request, sender, sendResponse, tabs[sender.tab.id]);
   }
   else if (request.greeting == "tags") {
      requestTags(request, sender, sendResponse, tabs[sender.tab.id]);
   }
   else if (request.greeting == "timestamp") {
      if (request.type == "ask") {
         requestTimestamp(request, sender, sendResponse, tabs[sender.tab.id]);
      }
      else if (cacheServe("timestamp", request.pid, sendResponse, doTimestamp, false, true)) {
         return true;
      }
      else {
         debug("Building timestamp (" + request.pid + ")");
         var ts = MissingE.buildTimestamp(request.stamp);
         if (ts !== null) {
            var info = {"timestamp":ts};
            saveCache(request.pid,info);
            doTimestamp(info, request.pid, sendResponse);
         }
         else {
            sendResponse({pid: id, success: false});
         }
      }
   }
   else if (request.greeting == "sidebarTweaks") {
      setSetting("MissingE_sidebarTweaks_accountNum", request.accountNum);
   }
   else if (request.greeting == "backupVal") {
      setSetting(request.key, request.val);
   }
   else if (request.greeting == "tumblrPermission") {
      checkPermission(request, sender, sendResponse, tabs[sender.tab.id],
                      getSetting("MissingE_postingTweaks_subEditRetries",MissingE.defaultRetries));
   }
   else if (request.greeting == "sendCrushes") {
      if (getSetting("MissingE_postCrushes_newTab",1) === 1) {
         chrome.tabs.create({windowId: sender.tab.windowId,
                             index: (sender.tab.index+1),
                             url: request.url}, function(tab) {
            crushes[tab.id] = {img: request.img, tags: request.tags};
         });
      }
      else {
         crushes[sender.tab.id] = {img: request.img, tags: request.tags};
         chrome.tabs.update(sender.tab.id, {url: request.url, selected: true});
      }
   }
   else if (request.greeting == "getCrushes") {
      if (crushes.hasOwnProperty(sender.tab.id)) {
         sendResponse(crushes[sender.tab.id]);
         delete crushes[sender.tab.id];
      }
   }
   else if (request.greeting == "sendReply") {
      if (request.newReply &&
          getSetting("MissingE_replyReplies_newTab",1) === 1) {
         chrome.tabs.create({windowId: sender.tab.windowId,
                             index: (sender.tab.index+1),
                             url: request.url}, function(tab) {
            replies[tab.id] = {reply: request.reply, tags: request.tags};
         });
      }
      else {
         replies[sender.tab.id] = {reply: request.reply, tags: request.tags};
         chrome.tabs.update(sender.tab.id, {url: request.url, selected: true});
      }
   }
   else if (request.greeting == "getReply") {
      if (replies.hasOwnProperty(sender.tab.id)) {
         sendResponse(replies[sender.tab.id]);
         delete replies[sender.tab.id];
      }
   }
   else if (request.greeting == "settings") {
      var settings = {};
      settings.experimental = getSetting("MissingE_experimentalFeatures_enabled",0);
      settings.component = request.component;
      switch(request.component) {
         case "askTweaks":
            settings.scroll = getSetting("MissingE_askTweaks_scroll",1);
            settings.betterAnswers = getSetting("MissingE_askTweaks_betterAnswers",0);
            settings.tagAsker = getSetting("MissingE_askTweaks_tagAsker",1);
            settings.defaultTags = getSetting("MissingE_askTweaks_defaultTags",'');
            if (settings.defaultTags !== '') {
               settings.defaultTags = settings.defaultTags.replace(/, /g,',').split(',');
            }
            settings.askDash = getSetting("MissingE_askTweaks_askDash",0);
            settings.massDelete = getSetting("MissingE_askTweaks_massDelete",1);
            settings.adjustDomain = MissingE.isTumblrURL(sender.tab.url, ["messages"]);
            break;
         case "sidebarTweaks":
            settings.retries = getSetting("MissingE_sidebarTweaks_retries",MissingE.defaultRetries);
            settings.accountNum = getSetting("MissingE_sidebarTweaks_accountNum",0);
            settings.slimSidebar = getSetting("MissingE_sidebarTweaks_slimSidebar",0);
            settings.followingLink = getSetting("MissingE_sidebarTweaks_followingLink",0);
            settings.addSidebar = getSetting("MissingE_sidebarTweaks_addSidebar",0);
            break;
         case "bookmarker":
            settings.backupMarks = getSetting("MissingE_bookmarker_marks","");
            settings.format = getSetting("MissingE_bookmarker_format",MissingE.defaultFormat);
            settings.addBar = getSetting("MissingE_bookmarker_addBar",1);
            break;
         case "dashboardTweaks":
            settings.replaceIcons = getSetting("MissingE_dashboardTweaks_replaceIcons",1);
            settings.postLinks = getSetting("MissingE_dashboardTweaks_postLinks",1);
            settings.reblogReplies = getSetting("MissingE_dashboardTweaks_reblogReplies",0);
            settings.disableAlert = getSetting("MissingE_dashboardTweaks_disableAlert",0);
            settings.widescreen = getSetting("MissingE_dashboardTweaks_widescreen",0);
            settings.queueArrows = getSetting("MissingE_dashboardTweaks_queueArrows",1);
            settings.expandAll = getSetting("MissingE_dashboardTweaks_expandAll",1);
            settings.massDelete = getSetting("MissingE_dashboardTweaks_massDelete",1);
            settings.randomQueue = getSetting("MissingE_dashboardTweaks_randomQueue",0);
            settings.sortableNotes = getSetting("MissingE_dashboardTweaks_sortableNotes",1);
            break;
         case "dashLinksToTabs":
            settings.newPostTabs = getSetting("MissingE_dashLinksToTabs_newPostTabs",1);
            settings.sidebar = getSetting("MissingE_dashLinksToTabs_sidebar",0);
            settings.reblogLinks = getSetting("MissingE_dashLinksToTabs_reblogLinks",0);
            settings.editLinks = getSetting("MissingE_dashLinksToTabs_editLinks",0);
            break;
         case "replyReplies":
            settings.showAvatars = getSetting("MissingE_replyReplies_showAvatars",1);
            settings.smallAvatars = getSetting("MissingE_replyReplies_smallAvatars",1);
            settings.addTags = getSetting("MissingE_replyReplies_addTags",1);
            settings.defaultTags = getSetting("MissingE_replyReplies_defaultTags",'');
            if (settings.defaultTags !== '') {
               settings.defaultTags = settings.defaultTags.replace(/, /g,',').split(',');
            }
            break;
         case "postCrushes":
            settings.prefix = getSetting("MissingE_postCrushes_prefix","Tumblr Crushes:");
            settings.crushSize = getSetting("MissingE_postCrushes_crushSize",1);
            settings.addTags = getSetting("MissingE_postCrushes_addTags",1);
            settings.showPercent = getSetting("MissingE_postCrushes_showPercent",1);
            break;
         case "postingTweaks":
            settings.photoReplies = getSetting("MissingE_postingTweaks_photoReplies",1);
            settings.uploaderToggle = getSetting("MissingE_postingTweaks_uploaderToggle",1);
            settings.addUploader = getSetting("MissingE_postingTweaks_addUploader",1);
            settings.quickButtons = getSetting("MissingE_postingTweaks_quickButtons",1);
            settings.blogSelect = getSetting("MissingE_postingTweaks_blogSelect",0);
            settings.tagQueuedPosts = getSetting("MissingE_postingTweaks_tagQueuedPosts",0);
            settings.queueTags = getSetting("MissingE_postingTweaks_queueTags",'');
            if (settings.queueTags !== '') {
               settings.queueTags = settings.queueTags.replace(/, /g,',').split(',');
            }
            break;
         case "magnifier":
            settings.magnifyAvatars = getSetting("MissingE_magnifier_magnifyAvatars",0);
            break;
         case "betterReblogs":
            settings.passTags = getSetting("MissingE_betterReblogs_passTags",1);
            settings.autoFillTags = getSetting("MissingE_betterReblogs_autoFillTags",1);
            settings.quickReblog = getSetting("MissingE_betterReblogs_quickReblog",0);
            settings.accountName = '0';
            if (getSetting("MissingE_betterReblogs_quickReblogAcctType",0) == 1) {
               settings.accountName = getSetting("MissingE_betterReblogs_quickReblogAcctName",'0');
            }
            settings.quickReblogForceTwitter = getSetting("MissingE_betterReblogs_quickReblogForceTwitter","default");
            settings.replaceIcons = (getSetting("MissingE_dashboardTweaks_enabled",1) == 1 && getSetting("MissingE_dashboardTweaks_replaceIcons",1) == 1) ? 1 : 0;
            settings.fullText = getSetting("MissingE_betterReblogs_fullText",0);
            settings.tagQueuedPosts = (getSetting("MissingE_postingTweaks_enabled",1) == 1 && getSetting("MissingE_postingTweaks_tagQueuedPosts",0) == 1) ? 1: 0;
            settings.queueTags = getSetting("MissingE_postingTweaks_queueTags",'');
            if (settings.queueTags !== '') {
               settings.queueTags = settings.queueTags.replace(/, /g,',').split(',');
            }
            settings.reblogAsks = getSetting("MissingE_betterReblogs_reblogAsks",0);
            break;
      }
      sendResponse(settings);
   }
   else if (request.greeting == "start") {
      addTab(sender.tab.id, sender.tab.url);
      chrome.tabs.executeScript(sender.tab.id, {file: "extension.js", allFrames: true});
      chrome.tabs.executeScript(sender.tab.id, {file: "core/utils.js", allFrames: true});
      if (!MissingE.isTumblrURL(request.url, ["askForm"])) {
         chrome.tabs.executeScript(sender.tab.id, {file: "jquery.min.js"});
         chrome.tabs.executeScript(sender.tab.id, {file: "core/common/ajaxEvents.js"});
      }
      var activeScripts = {};
      activeScripts.version = currVersion;
      var zindexFix = false;
      var loadedUI = false, loadedUIresizable = false, loadedUIsortable = false,
          loadedUIdraggable = false;
      var widenIframe = false;
      var injectSlimSidebar = false;
      if (sender.tab.url == request.url &&
          MissingE.isTumblrURL(sender.tab.url, ["massEditor"])) {
         if (getSetting("MissingE_massEditor_enabled",1) == 1) {
            activeScripts.massEditor = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "core/massEditor/massEditor.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "core/massEditor/massEditor.js"});
         }
         else
            activeScripts.massEditor = false;
      }
      if (sender.tab.url == request.url &&
          MissingE.isTumblrURL(sender.tab.url,
                      ["dashboard",
                       "blog",
                       "blogData",
                       "drafts",
                       "queue",
                       "messages",
                       "likes",
                       "tagged"])) {
         if (getSetting("MissingE_safeDash_enabled",1) == 1) {
            activeScripts.safeDash = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "core/safeDash/safeDash.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "core/safeDash/safeDash.js"});
         }
         else
            activeScripts.safeDash = false;

         if (getSetting("MissingE_dashLinksToTabs_enabled",1) == 1) {
            activeScripts.dashLinksToTabs = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "core/dashLinksToTabs/dashLinksToTabs.js"});
         }
         else
            activeScripts.dashLinksToTabs = false;

         if (getSetting("MissingE_bookmarker_enabled",1) == 1) {
            activeScripts.bookmarker = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "core/bookmarker/bookmarker.css"});
            if (!loadedUI) {
               loadedUI = true;
               loadUI(sender.tab.id, "core");
            }
            if (!loadedUIsortable) {
               loadedUIsortable = true;
               loadUI(sender.tab.id, "sortable");
            }
            chrome.tabs.executeScript(sender.tab.id, {file: "core/bookmarker/bookmarker.js"});
         }
         else
            activeScripts.bookmarker = false;

         if (getSetting("MissingE_magnifier_enabled",1) == 1 ||
             (getSetting("MissingE_askTweaks_enabled",1) == 1 &&
              getSetting("MissingE_askTweaks_askDash",0) == 1)) {
            zindexFix = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "lib/facebox/facebox.js"});
            chrome.tabs.insertCSS(sender.tab.id, {file: "lib/facebox/facebox.css"});
         }

         if (getSetting("MissingE_sidebarTweaks_enabled",1) == 1) {
            activeScripts.sidebarTweaks = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "core/sidebarTweaks/sidebarTweaks.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "core/sidebarTweaks/sidebarTweaks.js"});
            if (getSetting("MissingE_sidebarTweaks_slimSidebar",0) == 1) {
               injectSlimSidebar = true;
            }
         }
         else
            activeScripts.sidebarTweaks = false;

         if (getSetting("MissingE_magnifier_enabled",1) == 1) {
            activeScripts.magnifier = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "core/magnifier/magnifier.js"});
            chrome.tabs.insertCSS(sender.tab.id, {file: "core/magnifier/magnifier.css"});
         }
         else
            activeScripts.magnifier = false;

         if (getSetting("MissingE_dashboardTweaks_enabled",1) == 1) {
            activeScripts.dashboardTweaks = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "core/dashboardTweaks/replaceIcons.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "core/dashboardTweaks/dashboardTweaks.js"});
            if (getSetting("MissingE_dashboardTweaks_sortableNotes",1) == 1) {
               if (!loadedUI) {
                  loadedUI = true;
                  loadUI(sender.tab.id, "core");
               }
               if (!loadedUIsortable) {
                  loadedUIsortable = true;
                  loadUI(sender.tab.id, "sortable");
               }
               chrome.tabs.insertCSS(sender.tab.id, {file: "core/dashboardTweaks/notesSorter.css"});
            }
            if (getSetting("MissingE_dashboardTweaks_reblogQuoteFit",1) == 1)
               chrome.tabs.insertCSS(sender.tab.id, {file: "core/dashboardTweaks/reblogQuoteFit.css"});
            if (getSetting("MissingE_dashboardTweaks_wrapTags",1) == 1)
               chrome.tabs.insertCSS(sender.tab.id, {file: "core/dashboardTweaks/wrapTags.css"});
            if (getSetting("MissingE_dashboardTweaks_postLinks",1) == 1)
               chrome.tabs.insertCSS(sender.tab.id, {file: "core/dashboardTweaks/postLinks.css"});
            if (getSetting("MissingE_dashboardTweaks_massDelete",1) == 1 ||
                getSetting("MissingE_dashboardTweaks_randomQueue",0) == 1)
               chrome.tabs.insertCSS(sender.tab.id, {file: "core/dashboardTweaks/draftQueueTools.css"});
            if (getSetting("MissingE_dashboardTweaks_widescreen",0) == 1 &&
                !MissingE.isTumblrURL(sender.tab.url, ["settings"]))
               chrome.tabs.insertCSS(sender.tab.id, {file: "core/dashboardTweaks/widescreen.css"});
         }
         else
            activeScripts.dashboardTweaks = false;

         if (getSetting("MissingE_askTweaks_enabled",1) == 1) {
            activeScripts.askTweaks = true;
            if (!loadedUI) {
               loadedUI = true;
               loadUI(sender.tab.id, "core");
            }
            if (!loadedUIdraggable) {
               loadedUIdraggable = true;
               loadUI(sender.tab.id, "draggable");
            }
            chrome.tabs.insertCSS(sender.tab.id, {file: "core/askTweaks/askTweaks.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "core/askTweaks/askTweaks.js"});
         }
         else {
            activeScripts.askTweaks = false;
         }
      }
      if (MissingE.isTumblrURL(request.url, ["askForm"])) {
         if (getSetting("MissingE_askTweaks_enabled",1)) {
            activeScripts.askTweaks = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "core/askTweaks/askTweaks.js", allFrames: true});
         }
         else
            activeScripts.askTweaks = false;
      }
      if (sender.tab.url == request.url &&
          MissingE.isTumblrURL(sender.tab.url,
                      ["post",
                       "reblog",
                       "messages",
                       "drafts"])) {
         if (getSetting("MissingE_postingTweaks_enabled",1) == 1) {
            activeScripts.postingTweaks = true;
            if (!loadedUI) {
               loadedUI = true;
               loadUI(sender.tab.id, "core");
            }
            if (!loadedUIresizable) {
               loadedUIresizable = true;
               loadUI(sender.tab.id, "resizable");
            }
            chrome.tabs.executeScript(sender.tab.id, {file: "core/postingTweaks/postingTweaks.js"});
            chrome.tabs.insertCSS(sender.tab.id, {file: "core/postingTweaks/postingTweaks.css"});
         }
         else
            activeScripts.postingTweaks = false;
      }
      if (sender.tab.url == request.url &&
          MissingE.isTumblrURL(sender.tab.url, ["reblog"])) {
         if (getSetting("MissingE_betterReblogs_enabled",1) == 1) {
            activeScripts.betterReblogs = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "core/betterReblogs/betterReblogs_fill.js"});
         }
         else
            activeScripts.betterReblogs = false;
      }
      if (MissingE.isTumblrURL(request.url, ["iframe"]) &&
          !MissingE.isTumblrURL(sender.tab.url, ["post", "reblog"])) {
         // Fix issue with "endless pages" feature of FastestChrome
         chrome.tabs.insertCSS(sender.tab.id, {code:
            '.endless-pages-loaded-page iframe#tumblr_controls {' +
               'display:none;' +
            '}'
         });
         if (getSetting("MissingE_gotoDashPost_enabled",1) == 1) {
            activeScripts.gotoDashPost = true;
            widenIframe = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "core/gotoDashPost/gotoDashPost.js", allFrames: true});
         }
         else
            activeScripts.gotoDashPost = false;

         if (getSetting("MissingE_reblogYourself_enabled",1) == 1 &&
             getSetting("MissingE_reblogYourself_postPage",1) == 1) {
            activeScripts.reblogYourself = true;
            widenIframe = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "core/reblogYourself/reblogYourself_post.js", allFrames: true});
         }
         else
            activeScripts.reblogYourself = false;

         if (getSetting("MissingE_betterReblogs_enabled",1) == 1 &&
             getSetting("MissingE_betterReblogs_passTags",1) == 1) {
            activeScripts.betterReblogs = true;
            widenIframe = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "core/betterReblogs/betterReblogs_post.js", allFrames: true});
         }
         else
            activeScripts.betterReblogs = false;

         if (getSetting("MissingE_postingTweaks_enabled",1) == 1 &&
             getSetting("MissingE_postingTweaks_subEdit",1) == 1) {
            activeScripts.postingTweaks = true;
            widenIframe = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "core/postingTweaks/postingTweaks_post.js", allFrames: true});
         }
         else
            activeScripts.postingTweaks = false;
      }
      if (sender.tab.url == request.url &&
          MissingE.isTumblrURL(sender.tab.url,
                      ["dashboard",
                       "blog"])) {
         if (getSetting("MissingE_replyReplies_enabled",1) == 1) {
            activeScripts.replyReplies = true;
            chrome.tabs.insertCSS(sender.tab.id, {code: "#posts .notification .notification_type_icon { background-image:url('" + chrome.extension.getURL('core/replyReplies/notification_icons.png') + "') !important; } #posts ol.notes .notification_type_icon { background-image:url('" + chrome.extension.getURL('core/replyReplies/notes_icons.png') + "') !important; }"});
            chrome.tabs.insertCSS(sender.tab.id, {file: "core/replyReplies/replyReplies.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "core/replyReplies/replyReplies.js"});
         }
         else
            activeScripts.replyReplies = false;
      }
      if (sender.tab.url == request.url &&
          MissingE.isTumblrURL(sender.tab.url, ["reply"])) {
         if (getSetting("MissingE_replyReplies_enabled",1) == 1) {
            activeScripts.replyReplies = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "core/replyReplies/replyReplies_fill.js"});
         }
         else
            activeScripts.replyReplies = false;
      }
      if (sender.tab.url == request.url &&
          MissingE.isTumblrURL(sender.tab.url, ["following"])) {
         if (getSetting("MissingE_postCrushes_enabled",1) == 1) {
            activeScripts.postCrushes = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "core/postCrushes/postCrushes.js"});
         }
         else
            activeScripts.postCrushes = false;

         if (getSetting("MissingE_magnifier_enabled",1) == 1) {
            activeScripts.magnifier = true;
            zindexFix = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "lib/facebox/facebox.js"});
            chrome.tabs.insertCSS(sender.tab.id, {file: "lib/facebox/facebox.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "core/magnifier/magnifier.js"});
            chrome.tabs.insertCSS(sender.tab.id, {file: "core/magnifier/magnifier.css"});
         }
         else
            activeScripts.magnifier = false;
      }
      if (sender.tab.url == request.url &&
          MissingE.isTumblrURL(sender.tab.url, ["crushes"])) {
         if (getSetting("MissingE_postCrushes_enabled",1) == 1) {
            activeScripts.postCrushes = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "core/postCrushes/postCrushes_fill.js"});
         }
         else
            activeScripts.postCrushes = false;
      }
      if (sender.tab.url == request.url &&
          MissingE.isTumblrURL(sender.tab.url,
                      ["dashboard",
                       "blog",
                       "likes",
                       "tagged",
                       "messages"])) {
         if (getSetting("MissingE_timestamps_enabled",1) == 1) {
            activeScripts.timestamps = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "core/timestamps/timestamps.js"});
         }
         else
            activeScripts.timestamps = false;
      }
      if (sender.tab.url == request.url &&
          MissingE.isTumblrURL(sender.tab.url,
                      ["dashboard",
                       "blog",
                       "likes",
                       "tagged"])) {
         if (getSetting("MissingE_betterReblogs_enabled",1) == 1) {
            activeScripts.betterReblogs = true;
            if (getSetting("MissingE_betterReblogs_quickReblog",0) == 1) {
               zindexFix = true;
            }
            chrome.tabs.insertCSS(sender.tab.id, {file: "core/betterReblogs/quickReblog.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "core/betterReblogs/betterReblogs_dash.js"});
         }
         else
            activeScripts.betterReblogs = false;

         if (getSetting("MissingE_reblogYourself_enabled",1) == 1 &&
             getSetting("MissingE_reblogYourself_dashboard",1) == 1) {
            activeScripts.reblogYourself = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "core/reblogYourself/reblogYourself_dash.js"});
         }
         else
            activeScripts.reblogYourself = false;
      }
      if (zindexFix) {
         chrome.tabs.executeScript(sender.tab.id, {file: "core/common/zindexFix.js"});
      }
      if (widenIframe) {
         chrome.tabs.insertCSS(sender.tab.id, {file: "core/common/widenIframe.css"});
      }
      if (injectSlimSidebar) {
         chrome.tabs.insertCSS(sender.tab.id, {file: "core/sidebarTweaks/slimSidebar.css"});
      }

      activeScripts.url = request.url;
      sendResponse(JSON.stringify(activeScripts));
   }
});

function collapseSettings(toPref, oldA, oldB) {
   var prefA = localStorage[oldA];
   var prefB = localStorage[oldB];
   var newPref;
   if (prefA || prefB) {
      console.log('"' + oldA + '" and "' + oldB + '" depracated. Moving settings to "' + toPref + '"');
   }
   if (prefA === "1" || prefB === "1") {
      newPref = "1";
   }
   if (prefA || prefB) {
      if (localStorage.getItem(toPref) === null) {
         localStorage[toPref] = newPref;
      }
      localStorage.removeItem(oldA);
      localStorage.removeItem(oldB);
   }
}

function moveSetting(oldpref, newpref) {
   var pref;
   if ((pref = localStorage[oldpref])) {
      console.log('"' + oldpref + '" depracated. Moving setting to "' + newpref + '"');
      if (localStorage.getItem(newpref) === null) {
         localStorage[newpref] = pref;
      }
      localStorage.removeItem(oldpref);
   }
}

function moveAllSettings(oldgroup, newgroup) {
   var re = new RegExp("^MissingE_" + oldgroup + "_");
   for (i in localStorage) {
      if (localStorage.hasOwnProperty(i) &&
          re.test(i)) {
         var newpref = i.replace(re,'MissingE_' + newgroup + '_');
         console.log('"' + i + '" depracated. Moving setting to "' + newpref + '"');
         if (localStorage.getItem(newpref) === null) {
            localStorage[newpref] = localStorage[i];
         }
         localStorage.removeItem(i);
      }
   }
}

function invertSetting(oldpref, newpref) {
   var pref;
   if ((pref = localStorage[oldpref])) {
      console.log('"' + oldpref + '" changed to inverted setting "' + newpref + '"');
      if (localStorage.getItem(newpref) === null) {
         localStorage[newpref] = (pref === "1" || pref === 1 ? "0" : "1");
      }
      localStorage.removeItem(oldpref);
   }
}

function getExternalVersion() {
   $.ajax({
      type: "GET",
      url: 'http://missinge.infraware.ca/version',
      dataType: "text",
      success: function(data, textStatus, xhr) {
         var versionInfo = data.split(" ");
         versionInfo[versionInfo.length-1] =
            versionInfo[versionInfo.length-1].replace(/\s*$/m,'');
         setSetting('MissingE_externalVersion', versionInfo[0]);
         if (versionInfo.length > 1) {
            setSetting('MissingE_externalVersion_link', versionInfo[1]);
         }
         else {
            setSetting('MissingE_externalVersion_link', '');
         }
      }
   });
}

currVersion = getVersion();

function fixupSettings() {
   moveAllSettings('askFixes','askTweaks');
   moveAllSettings('dashboardFixes','dashboardTweaks');
   moveAllSettings('postingFixes','postingTweaks');
   moveSetting('MissingE_dashboardTweaks_slimSidebar','MissingE_sidebarTweaks_slimSidebar');
   moveSetting('MissingE_dashboardTweaks_followingLink','MissingE_sidebarTweaks_followingLink');
   collapseSettings('MissingE_askTweaks_betterAnswers','MissingE_askTweaks_buttons','MissingE_askTweaks_tags');
   invertSetting('MissingE_betterReblogs_noPassTags','MissingE_betterReblogs_passTags');
}

function onStart(currVersion, prevVersion) {
   if (prevVersion && prevVersion !== currVersion) {
      console.log("Updated Missing e (" +
                  prevVersion + " => " + currVersion +
                  ")");
      setSetting('MissingE_compatCheck',0);
   }
   else if (!prevVersion) {
      console.log("Installed Missing e " + currVersion);
      setSetting('MissingE_compatCheck',0);
      chrome.tabs.create({url:chrome.extension.getURL("core/options.html")});
   }
   setSetting('MissingE_version',currVersion);
}

onStart(currVersion, getSetting('MissingE_version',null));
getExternalVersion();
fixupSettings();

var fivedays = 432000000;
var now = (new Date()).valueOf();
if (now >= parseInt(getSetting("MissingE_compatCheck",0)) + fivedays) {
   localStorage.setItem("MissingE_compatCheck",now);
   chrome.management.getAll(function(arr) {
      var repl = new Array();
      var ids = new Array();
      for (i=0; i<arr.length; i++) {
         if (arr[i].enabled) {
            switch (arr[i].name) {
               case "Tumblr - Photo Replies Always":
               case "Tumblr post - Upload Photo for all posts":
               case "Tumblr Bookmarker":
               case "Tumblr Dash Links To Tabs":
               case "Tumblr Goto Dash Post":
               case "Tumblr Post Crushes":
               case "Tumblr Reblog Yourself":
               case "Tumblr Reply Replies":
               case "Tumblr SafeDash":
               case "Tumblr Timestamps":
               //case "Tumblr Sidebr":
                  repl.push(arr[i].name);
                  ids.push(arr[i].id);
                  break;
            }
         }
      }

      if (repl.length > 0) {
         var msg = "======\n Missing e\n======\n\n" +
                   "Functionality of the following installed scripts has been replaced by the 'Missing e' extension. " +
                   "Using them may cause compatibility problems.\n\n" +
                   " - " + repl.join("\n - ") +
                   "\n\nDo you want to disable them?\n\nYou can re-enable or uninstall them later in your " +
                   "Extensions menu.\n\nSee http://missinge.infraware.ca/faq for more information.";
         var answer = confirm(msg);
         if (answer) {
            for (i=0; i<ids.length; i++) {
               chrome.management.setEnabled(ids[i], false);
               if (repl[i] === "Tumblr Sidebr") {
                  setSetting("MissingE_sidebarTweaks_addSidebar",1);
               }
            }
         }
      }
   });
}
</script>
</head>
</html>
