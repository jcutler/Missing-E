<!--
 - 'Missing e' Extension
 -
 - Copyright 2011, Jeremy Cutler
 - Released under the GPL version 3 licence.
 - SEE: GPL-LICENSE.txt
 -
 - This file is part of 'Missing e'.
 -
 - 'Missing e' is free software: you can redistribute it and/or modify
 - it under the terms of the GNU General Public License as published by
 - the Free Software Foundation, either version 3 of the License, or
 - (at your option) any later version.
 -
 - 'Missing e' is distributed in the hope that it will be useful,
 - but WITHOUT ANY WARRANTY; without even the implied warranty of
 - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 - GNU General Public License for more details.
 -
 - You should have received a copy of the GNU General Public License
 - along with 'Missing e'.  If not, see [http://www.gnu.org/licenses/].
-->
<html>
<head>
<script type="text/javascript" src="common/jquery.min.js"></script>
<script type="text/javascript" src="common/defs.js"></script>
<script type="text/javascript" src="common/utils.js"></script>
<script type="text/javascript" src="common/storage.js"></script>
<script type="text/javascript" src="common/localizations.js"></script>
<script>
var maxActiveAjax = 15;
var activeAjax = 0;
var activeRequests = {};
var waitQueue = [];
var onHold = {};
var numSleeping = 0;
var cache = {};
var cacheElements = 0;
var cacheClear;
var clearQueues;
var fiveMinutes = 300000;
var tenSeconds = 10000;
var debugMode = false;
var tabs = {};
var followCheckerTab = -1;
var formKey;
var followYou = [];
var youFollow = [];

function addTab(id, url) {
   var d = (new Date()).valueOf();
   tabs[id] = d;
   debug("Adding tab (" + id + ") " + d);
}

chrome.tabs.onRemoved.addListener(function(id, removeInfo) {
   if (tabs[id]) {
      delete tabs[id];
      debug("Removing tab (" + id + ")");
   }
});

cacheClear = setInterval(function() {
   cache = {};
   cacheElements = 0;
}, fiveMinutes);
clearQueues = setInterval(function() {
   if (activeAjax == 0) {
      wakeAll();
      dequeueAjax();
   }
}, tenSeconds);

function debug(msg) {
   if (debugMode) {
      console.log(msg);
   }
}

function doTags(stamp, id, sendResponse) {
   var tags = stamp["tags"];
   if (!tags) {
      tags = [];
   }
   if (stamp["type"] === "regular" &&
       getStorage("MissingE_betterReblogs_fullText",0) === 1) {
      fullText = true;
   }
   else { fullText = false; }
   sendResponse({success: true, data: tags, fullText: fullText});
}

function doTimestamp(stamp, id, sendResponse) {
   var ts = stamp["unix-timestamp"];
   var d = new Date(ts*1000);
   var ins = getStorage("MissingE_timestamps_format",defaultFormat);
   ins = getFormattedDate(d, ins);
   if (stamp["url"]) {
      ins = ins.replace(/%X/g,'<a href="' + stamp["url"].match(/http:\/\/[^\/]*/)[0] + '/api/read/json?id='+id + '">' + id + '</a>');
   }
   else {
      ins = ins.replace(/%X/g,id);
   }
   sendResponse({pid: id, success: true, data: ins});
}

function doReblogDash(stamp, id, sendResponse) {
   var key = stamp["reblog-key"];
   var replaceIcons = getStorage("MissingE_dashboardFixes_enabled",1) == 1 &&
                      getStorage("MissingE_dashboardFixes_replaceIcons",1) == 1;
   sendResponse({pid: id, success: true, data: key, icons: replaceIcons});
}

function doMagnifier(stamp, id, sendResponse) {
   var url;
   if (stamp.photos.length > 0) {
      url = new Array();
      for (i=0; i<stamp.photos.length; i++) {
         url.push(stamp.photos[i]["photo-url-1280"]);
         var cap = stamp.photos[i]["caption"];
         if (cap == undefined || cap == null)
            url.push("");
         else
            url.push(cap);
      }
      url = JSON.stringify(url);
   }
   else {
      url = stamp["photo-url-1280"];
   }
   sendResponse({pid: id, success: true, data: url});
}

function queueAjax(details) {
   waitQueue.push(details);
   debug("Queueing " + details.type + " request. " + (waitQueue.length) + " in queue");
}

function dequeueAjax(id) {
   if (id) {
      activeAjax--;
      wakeById(id);
      delete activeRequests[id];
   }
   while (activeAjax < maxActiveAjax) {
      var call = waitQueue.shift();
      if (!call) { return false; }
      debug("Dequeueing " + call.type + " request. " + (waitQueue.length) + " in queue");
      runItem(call);
   }
}

function saveCache(id, entry) {
   cacheElements++;
   for (var i in entry) {
      if (i !== "photos" &&
          i !== "photo-url-1280" &&
          i !== "unix-timestamp" &&
          i !== "reblog-key" &&
          i !== "url" &&
          i !== "tags" &&
          i !== "type") {
         delete entry[i];
      }
   }
   cache[id] = entry;
}

function cacheServe(type, id, sendResponse, fn, midFlight) {
   var entry;
   if ((entry = cache[id])) {
      debug(type + " request (" + id + ") served from cache.");
      if (midFlight) {
         dequeueAjax(id);
      }
      else {
         dequeueAjax();
      }
      fn(entry, id, sendResponse);
      return true;
   }
   else {
      return false;
   }
}

function wakeAll() {
   var call;
   for (var i in onHold) {
      call = onHold[i];
      delete onHold[i];
      numSleeping --;
      debug("Waking " + call.type + " request (" + call.request.pid + "). " + numSleeping + " still asleep");
      runItem(call);
   }
}

function runItem(call) {
   if (call.type === "magnifier") {
      requestMagnifier(call.request, call.sender, call.sendResponse, call.hash);
   }
   else if (call.type === "reblogYourself") {
      requestReblogYourself(call.request, call.sender, call.sendResponse, call.hash);
   }
   else if (call.type === "timestamp") {
      requestTimestamp(call.request, call.sender, call.sendResponse, call.hash);
   }
   else if (call.type === "tags") {
      requestTags(call.request, call.sender, call.sendResponse, call.hash);
   }
}

function wakeById(id) {
   var i,j;
   for (i=0; activeRequests[id] && i<activeRequests[id].length; i++) {
      var call;
      if ((call = activeRequests[id][i])) {
         delete onHold[call.type + call.request.pid];
         numSleeping--;
         debug("Selectively waking " + call.type + " request (" + call.request.pid + "). " + numSleeping + " still asleep");
         runItem(call);
      }
   }
}

function isRequested(details) {
   return false;
   /* Not working
   var bucket;
   if ((bucket = activeRequests[details.request.pid])) {
      onHold[details.type + details.request.pid] = details;
      bucket.push(details);
      numSleeping++;
      debug("Sleeping " + details.type + " request (" + details.request.pid + "). " + numSleeping + " asleep");
      return true;
   }
   else {
      return false;
   }
   */
}

function startAjax(id) {
   activeAjax++;
   activeRequests[id] = [];
}

function doAskAjax(request, sender, sendResponse, hash, retries, type, doFunc) {
   debug("AJAX " + type + " request (" + request.pid + ")");
   startAjax(request.pid);
   var failMsg = {success:false};
   $.ajax({
      type: "GET",
      url: request.url + request.pid,
      dataType: "html",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.pid,
      tabId: sender.tab.id,
      tabHash: hash,
      error: function(xhr, textStatus) {
         if (xhr.status == 404) {
            debug(type + " request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            sendResponse(failMsg);
            return;
         }
         if (this.tabHash !== tabs[this.tabId]) {
            debug("Stop " + type + " request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         if (cacheServe(type, request.pid, sendResponse, doFunc, true)) {
            return true;
         }
         else {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               debug("Retry " + type + " request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               sendResponse(failMsg);
            }
         }
      },
      success: function(data, textStatus) {
         var closed = (this.tabHash !== tabs[this.tabId]);
         if (!(/<input[^>]*name="post\[date\]"[^>]*>/.test(data))) {
            if (closed) {
               debug("Stop " + type + " request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe(type, request.pid, sendResponse, doFunc, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  debug("Retry " + type + " request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  debug(type + " request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  sendResponse(failMsg);
               }
            }
         }
         else {
            var failed = false;
            var txt;
            var inp = data.match(/<input[^>]*name="post\[date\]"[^>]*>/);
            if (!inp) { failed = true; }
            else {
               txt = inp[0].match(/value="([^"]*)"/);
               if (!txt || txt.length < 2) {
                  failed = true;
               }
               else {
                  txt = txt[1];
               }
            }
            if (failed) {
               debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               sendResponse(failMsg);
               return;
            }
            var m = txt.match(/([A-Za-z]+) ([0-9]+)[^,]*, ([0-9]+) ([0-9]+):([0-9]+)([aApP][mM])/);
            var d = new Date(m[1] + ' ' + m[2] + ', ' + m[3] + ' ' +
                             (m[6]=='pm' && m[4] !== '12' ? parseInt(m[4])+12 : m[4]) +
                             ':' + m[5] + ':00 GMT');
            var stamp = Math.round(d.getTime()/1000);
            var info = {"unix-timestamp":stamp};
            saveCache(this.targetId, info);
            dequeueAjax(this.targetId);
            if (!closed) {
               doFunc(info, this.targetId, sendResponse);
            }
         }
      }
   });
}

function doAjax(request, sender, sendResponse, hash, retries, type, doFunc,
                additional) {
   debug("AJAX " + type + " request (" + request.pid + ")");
   startAjax(request.pid);
   var failMsg = {success:false};
   if (additional) {
      for (i in additional) {
         if (additional.hasOwnProperty(i)) {
            failMsg[i] = additional[i];
         }
      }
   }
   $.ajax({
      type: "GET",
      url: request.url + "/api/read/json?id=" + request.pid,
      dataType: "text",
      tryCount: 0,
      retryLimit: retries,
      targetId: request.pid,
      tabId: sender.tab.id,
      tabHash: hash,
      error: function(xhr, textStatus) {
         if (xhr.status === 404) {
            debug(type + " request (" + this.targetId + ") not found");
            dequeueAjax(this.targetId);
            sendResponse(failMsg);
            return;
         }
         if (this.tabHash !== tabs[this.tabId]) {
            debug("Stop " + type + " request: Tab closed or changed.");
            dequeueAjax(this.targetId);
            return;
         }
         if (cacheServe(type, request.pid, sendResponse, doFunc, true)) {
            return true;
         }
         else {
            this.tryCount++;
            if (this.tryCount <= this.retryLimit) {
               debug("Retry " + type + " request (" + this.targetId + ")");
               $.ajax(this);
               return;
            }
            else {
               debug(type + " request (" + this.targetId + ") failed");
               dequeueAjax(this.targetId);
               sendResponse(failMsg);
            }
         }
      },
      success: function(data, textStatus) {
         var closed = (this.tabHash !== tabs[this.tabId]);
         if (!(/^\s*var\s+tumblr_api_read/.test(data))) {
            if (closed) {
               debug("Stop " + type + " request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe(type, request.pid, sendResponse, doFunc, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  debug("Retry " + type + " request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  debug(type + " request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  sendResponse(failMsg);
               }
            }
         }
         else {
            var txt = data.replace(/^\s*var\s+tumblr_api_read\s+=\s+/,'').replace(/;\s*$/,'');
            var stamp = JSON.parse(txt);
            var info = stamp["posts"][0];
            saveCache(this.targetId, info);
            dequeueAjax(this.targetId);
            if (!closed) {
               doFunc(info, this.targetId, sendResponse);
            }
         }
      }
   });
}

function requestTags(request, sender, sendResponse, hash) {
   if (hash !== tabs[sender.tab.id]) {
      debug("Stop tags request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("tags", request.pid, sendResponse, doTags, false)) {
      return true;
   }
   else if (isRequested({type: "tags", request: request, sender: sender, sendResponse: sendResponse})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "tags", request: request, sender: sender, sendResponse: sendResponse, hash: hash});
   }
   else {
      doAjax(request, sender, sendResponse, hash,
             getStorage("MissingE_betterReblogs_retries",defaultRetries),
             "tags", doTags);
   }
}

function requestReblogYourself(request, sender, sendResponse, hash) {
   if (hash !== tabs[sender.tab.id]) {
      debug("Stop reblogYourself request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("reblogYourself", request.pid, sendResponse, doReblogDash, false)) {
      return true;
   }
   else if (isRequested({type: "reblogYourself", request: request, sender: sender, sendResponse: sendResponse})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "reblogYourself", request: request, sender: sender, sendResponse: sendResponse, hash: hash});
   }
   else {
      doAjax(request, sender, sendResponse, hash,
             getStorage("MissingE_reblogYourself_retries",defaultRetries),
             "reblogYourself", doReblogDash,
             {
               pid:request.pid,
               icons:getStorage("MissingE_dashboardFixes_enabled",1) == 1 && 
                     getStorage("MissingE_dashboardFixes_replaceIcons",1) == 1
             });
   }
}

function requestTimestamp(request, sender, sendResponse, hash) {
   if (hash !== tabs[sender.tab.id]) {
      debug("Stop timestamp request: Tab closed or changed.");
      dequeueAjax();
      return false;
   }
   else if (cacheServe("timestamp", request.pid, sendResponse, doTimestamp, false)) {
      return true;
   }
   else if (isRequested({type: "timestamp", request: request, sender: sender, sendResponse: sendResponse})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "timestamp", request: request, sender: sender, sendResponse: sendResponse, hash: hash});
   }
   else if (request.url === 'http://www.tumblr.com/edit/') {
      doAskAjax(request, sender, sendResponse, hash,
                getStorage("MissingE_timestamps_retries",defaultRetries),
                "timestamp", doTimestamp);
   }
   else {
      doAjax(request, sender, sendResponse, hash,
             getStorage("MissingE_timestamps_retries",defaultRetries),
             "timestamp", doTimestamp,
             {pid: request.pid, debugMode: debugMode});
   }
}

function requestMagnifier(request, sender, sendResponse, hash) {
   if (hash !== tabs[sender.tab.id]) {
      debug("Stop magnifier request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("magnifier", request.pid, sendResponse, doMagnifier, false)) {
      return true;
   }
   else if (isRequested({type: "magnifier", request: request, sender: sender, sendResponse: sendResponse})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "magnifier", request: request, sender: sender, sendResponse: sendResponse, hash: hash});
   }
   else {
      doAjax(request, sender, sendResponse, hash,
             getStorage("MissingE_magnifier_retries",defaultRetries),
             "magnifier", doMagnifier,
             {pid: request.pid});
   }
}

function closeTab(url, currentId) {
   chrome.windows.getAll({populate: true},
                         function (windows) {
      var i,j;
      for (i=0; i<windows.length; i++) {
         for (j=0; j<windows[i].tabs.length; j++) {
            if (windows[i].tabs[j].url == url &&
                windows[i].tabs[j].id != currentId) {
               chrome.tabs.remove(windows[i].tabs[j].id);
            }
         }
      }
   });
}

chrome.tabs.onRemoved.addListener(function(id, info) {
   if (id === followCheckerTab) {
      followYou = [];
      youFollow = [];
      formKey = null;
      followCheckerTab = -1;
   }
});

chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
   if (!sender.tab) sendResponse({});
   else if (request.greeting == "close-options") {
      closeTab(chrome.extension.getURL('options.html'), sender.tab.id);
   }
   else if (request.greeting == "close-followChecker") {
      closeTab(chrome.extension.getURL('followChecker/followChecker.html'));
   }
   else if (request.greeting == "unfollowerIgnore") {
      localStorage.setItem('MissingE_unfollower_ignore', request.list);
   }
   else if (request.greeting == "followChecker") {
      followYou = request.followYou;
      youFollow = request.youFollow;
      formKey = request.formKey;
      closeTab(chrome.extension.getURL('followChecker/followChecker.html'));
      chrome.tabs.create({windowId: sender.tab.windowId,
                           index: (sender.tab.index+1),
                           url: chrome.extension.getURL('followChecker/followChecker.html')},
                         function(newtab) {
         followCheckerTab = newtab.id;
      });
   }
   else if (request.greeting == "followChecker_fill") {
      if (sender.tab.id == followCheckerTab &&
          formKey) {
         sendResponse({success:true, formKey: formKey,
                       followYou: followYou, youFollow: youFollow});
      }
      else {
         sendResponse({success:false});
      }
   }
   else if (request.greeting == "unfollow") {
      var idx = $.inArray(request.tumblrId + ';' +
                          request.tumblrURL + ';' +
                          request.tumblrImg, youFollow);
      if (idx != -1) {
         youFollow.splice(idx,1);
      }
   }
   else if (request.greeting == "follow") {
      var idx = $.inArray(request.tumblrId + ';' +
                          request.tumblrURL + ';' +
                          request.tumblrImg, followYou);
      if (idx != -1) {
         followYou.splice(idx,1);
      }
   }
   else if (request.greeting == "magnifier") {
      requestMagnifier(request, sender, sendResponse, tabs[sender.tab.id]);
   }
   else if (request.greeting == "reblogYourself") {
      requestReblogYourself(request, sender, sendResponse, tabs[sender.tab.id]);
   }
   else if (request.greeting == "timestamp") {
      requestTimestamp(request, sender, sendResponse, tabs[sender.tab.id]);
   }
   else if (request.greeting == "tags") {
      requestTags(request, sender, sendResponse, tabs[sender.tab.id]);
   }
   else if (request.greeting == "sidebarTweaks") {
      setStorage("MissingE_sidebarTweaks_accountNum", request.accountNum);
      sendResponse();
   }
   else if (request.greeting == "settings") {
      var settings = {};
      settings.experimental = getStorage("MissingE_experimentalFeatures_enabled",0);
      switch(request.component) {
         case "askFixes":
            settings.scroll = getStorage("MissingE_askFixes_scroll",1);
            settings.buttons = getStorage("MissingE_askFixes_buttons",0);
            settings.tags = getStorage("MissingE_askFixes_tags",0);
            settings.tagAsker = getStorage("MissingE_askFixes_tagAsker",1);
            settings.defaultTags = getStorage("MissingE_askFixes_defaultTags",'');
            if (settings.defaultTags !== '') {
               settings.defaultTags = settings.defaultTags.replace(/, /g,',').split(',');
            }
            break;
         case "sidebarTweaks":
            settings.retries = getStorage("MissingE_sidebarTweaks_retries",defaultRetries);
            settings.accountNum = getStorage("MissingE_sidebarTweaks_accountNum",0);
            settings.hideRadar = getStorage("MissingE_sidebarTweaks_hideRadar",0);
            settings.slimSidebar = getStorage("MissingE_sidebarTweaks_slimSidebar",0);
            settings.followingLink = getStorage("MissingE_sidebarTweaks_followingLink",0);
            settings.addSidebar = getStorage("MissingE_sidebarTweaks_addSidebar",0);
            break;
         case "bookmarker":
            settings.format = getStorage("MissingE_bookmarker_format",defaultFormat);
            settings.addBar = getStorage("MissingE_bookmarker_addBar",1);
            break;
         case "dashboardFixes":
            settings.replaceIcons = getStorage("MissingE_dashboardFixes_replaceIcons",1);
            settings.timeoutAJAX = getStorage("MissingE_dashboardFixes_timeoutAJAX",1);
            settings.timeoutLength = getStorage("MissingE_dashboardFixes_timeoutLength",10);
            settings.postLinks = getStorage("MissingE_dashboardFixes_postLinks",1);
            settings.reblogReplies = getStorage("MissingE_dashboardFixes_reblogReplies",0);
            settings.widescreen = getStorage("MissingE_dashboardFixes_widescreen",0);
            settings.queueArrows = getStorage("MissingE_dashboardFixes_queueArrows",1);
            settings.expandAll = getStorage("MissingE_dashboardFixes_expandAll",1);
            settings.maxBig = getStorage("MissingE_dashboardFixes_maxBig",0);
            settings.maxBigSize = getStorage("MissingE_dashboardFixes_maxBigSize",defaultMaxBig);
            break;
         case "dashLinksToTabs":
            settings.newPostTabs = getStorage("MissingE_dashLinksToTabs_newPostTabs",1);
            settings.sidebar = getStorage("MissingE_dashLinksToTabs_sidebar",0);
            settings.reblogLinks = getStorage("MissingE_dashLinksToTabs_reblogLinks",0);
            settings.editLinks = getStorage("MissingE_dashLinksToTabs_editLinks",0);
            break;
         case "replyReplies":
            settings.showAvatars = getStorage("MissingE_replyReplies_showAvatars",1);
            settings.smallAvatars = getStorage("MissingE_replyReplies_smallAvatars",1);
            settings.addTags = getStorage("MissingE_replyReplies_addTags",1);
            settings.newTab = getStorage("MissingE_replyReplies_newTab",1);
            break;
         case "postCrushes":
            settings.prefix = getStorage("MissingE_postCrushes_prefix","Tumblr Crushes:");
            settings.crushSize = getStorage("MissingE_postCrushes_crushSize",1);
            settings.addTags = getStorage("MissingE_postCrushes_addTags",1);
            settings.showPercent = getStorage("MissingE_postCrushes_showPercent",1);
            break;
         case "postingFixes":
            settings.photoReplies = getStorage("MissingE_postingFixes_photoReplies",1);
            settings.uploaderToggle = getStorage("MissingE_postingFixes_uploaderToggle",1);
            settings.addUploader = getStorage("MissingE_postingFixes_addUploader",1);
            settings.quickButtons = getStorage("MissingE_postingFixes_quickButtons",1);
            settings.blogSelect = getStorage("MissingE_postingFixes_blogSelect",0);
            break;
         case "unfollower":
            settings.addSidebar = getStorage("MissingE_sidebarTweaks_addSidebar",0);
            if (getStorage("MissingE_sidebarTweaks_enabled",1) == 0) {
               settings.addSidebar = 0;
            }
            settings.ignore = getStorage("MissingE_unfollower_ignore",'');
         case "followChecker":
            settings.retries = getStorage("MissingE_" + request.component + "_retries",defaultRetries);
            break;
         case "betterReblogs":
            settings.passTags = getStorage("MissingE_betterReblogs_passTags",1);
            settings.autoFillTags = getStorage("MissingE_betterReblogs_autoFillTags",1);
            settings.quickReblog = getStorage("MissingE_betterReblogs_quickReblog",0);
            settings.accountName = '0';
            if (getStorage("MissingE_betterReblogs_quickReblogAcctType",0) == 1) {
               settings.accountName = getStorage("MissingE_betterReblogs_quickReblogAcctName",'0');
            }
            settings.replaceIcons = (getStorage("MissingE_dashboardFixes_enabled",1) == 1 && getStorage("MissingE_dashboardFixes_replaceIcons",1) == 1) ? 1 : 0;
            settings.fullText = getStorage("MissingE_betterReblogs_fullText",0);
            break;
      }
      sendResponse(JSON.stringify(settings));
   }
   else if (request.greeting == "start") {
      addTab(sender.tab.id, sender.tab.url);
      chrome.tabs.executeScript(sender.tab.id, {file: "common/jquery.min.js"});
      chrome.tabs.executeScript(sender.tab.id, {file: "common/defs.js"});
      chrome.tabs.executeScript(sender.tab.id, {file: "common/storage.js"});
      chrome.tabs.executeScript(sender.tab.id, {file: "common/utils.js"});
      var activeScripts = {};
      var zindexFix = false;
      if (sender.tab.url == request.url &&
          /http:\/\/www\.tumblr\.com\/mega-editor\//.test(sender.tab.url)) {
         if (getStorage("MissingE_massEditor_enabled",1) == 1) {
            activeScripts.massEditor = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "massEditor/massEditor.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "massEditor/massEditor.js"});
         }
         else
            activeScripts.massEditor = false;
      }
      if (sender.tab.url == request.url &&
          (/http:\/\/www\.tumblr\.com\/dashboard/.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/drafts/.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/likes/.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/liked\/by\//.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/messages/.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/inbox/.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/submissions/.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/queue/.test(sender.tab.url) ||
           (/http:\/\/www\.tumblr\.com\/tumblelog/.test(sender.tab.url) &&
            !(/http:\/\/www\.tumblr\.com\/tumblelog\/[^\/]*\/new\//
              .test(sender.tab.url)) &&
            !(/http:\/\/www\.tumblr\.com\/tumblelog\/[^\/]*\/processing/
              .test(sender.tab.url))) ||
           /http:\/\/www\.tumblr\.com\/tagged\//.test(sender.tab.url))) {
         if (getStorage("MissingE_safeDash_enabled",1) == 1) {
            activeScripts.safeDash = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "safeDash/safeDash.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "safeDash/safeDash.js"});
         }
         else
            activeScripts.safeDash = false;
      }
      if (sender.tab.url == request.url &&
          (/http:\/\/www\.tumblr\.com\/dashboard/.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/drafts/.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/likes/.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/liked\/by\//.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/messages/.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/inbox/.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/submissions/.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/queue/.test(sender.tab.url) ||
           (/http:\/\/www\.tumblr\.com\/tumblelog/.test(sender.tab.url) &&
            !(/http:\/\/www\.tumblr\.com\/tumblelog\/[^\/]*\/new\//
              .test(sender.tab.url))) ||
           /http:\/\/www\.tumblr\.com\/tagged\//.test(sender.tab.url))) {
         if (getStorage("MissingE_dashLinksToTabs_enabled",1) == 1) {
            activeScripts.dashLinksToTabs = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "dashLinksToTabs/dashLinksToTabs.js"});
         }
         else
            activeScripts.dashLinksToTabs = false;

         if (getStorage("MissingE_bookmarker_enabled",1) == 1) {
            activeScripts.bookmarker = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "bookmarker/bookmarker.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "common/jquery-ui.min.js"});
            chrome.tabs.executeScript(sender.tab.id, {file: "bookmarker/bookmarker.js"});
         }
         else
            activeScripts.bookmarker = false;

         if (getStorage("MissingE_unfollower_enabled",1) == 1 ||
             getStorage("MissingE_followChecker_enabled",1) == 1 ||
             getStorage("MissingE_magnifier_enabled",1) == 1) {
            zindexFix = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "facebox/facebox.js"});
            chrome.tabs.insertCSS(sender.tab.id, {file: "facebox/facebox.css"});
         }

         if (getStorage("MissingE_unfollower_enabled",1) == 1) {
            activeScripts.unfollower = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "unfollower/unfollower.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "unfollower/unfollower.js"});
         }
         else
            activeScripts.unfollower = false;

         if (getStorage("MissingE_followChecker_enabled",1) == 1) {
            activeScripts.followChecker = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "followChecker/followChecker.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "followChecker/followChecker.js"});
         }
         else
            activeScripts.followChecker = false;

         if (getStorage("MissingE_sidebarTweaks_enabled",1) == 1) {
            activeScripts.sidebarTweaks = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "sidebarTweaks/sidebarTweaks.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "sidebarTweaks/sidebarTweaks.js"});
            if (getStorage("MissingE_sidebarTweaks_slimSidebar",0) == 1)
               chrome.tabs.insertCSS(sender.tab.id, {file: "sidebarTweaks/slimSidebar.css"});
         }
         else
            activeScripts.sidebarTweaks = false;

         if (getStorage("MissingE_dashboardFixes_enabled",1) == 1) {
            activeScripts.dashboardFixes = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "dashboardFixes/replaceIcons.css"});
            chrome.tabs.insertCSS(sender.tab.id, {file: "dashboardFixes/queueArrows.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "dashboardFixes/dashboardFixes.js"});
            if (getStorage("MissingE_dashboardFixes_reblogQuoteFit",1) == 1)
               chrome.tabs.insertCSS(sender.tab.id, {file: "dashboardFixes/reblogQuoteFit.css"});
            if (getStorage("MissingE_dashboardFixes_wrapTags",1) == 1)
               chrome.tabs.insertCSS(sender.tab.id, {file: "dashboardFixes/wrapTags.css"});
            if (getStorage("MissingE_dashboardFixes_postLinks",1) == 1)
               chrome.tabs.insertCSS(sender.tab.id, {file: "dashboardFixes/postLinks.css"});
            if (getStorage("MissingE_dashboardFixes_widescreen",0) == 1 &&
                !(/http:\/\/www\.tumblr\.com\/tumblelog\/[^\/]*\/settings/.test(sender.tab.url)))
               chrome.tabs.insertCSS(sender.tab.id, {file: "dashboardFixes/widescreen.css"});
         }
         else
            activeScripts.dashboardFixes = false;
      }
      if (/http:\/\/www\.tumblr\.com\/ask_form\//.test(request.url)) {
         if (getStorage("MissingE_askFixes_enabled",1) == 1 &&
             getStorage("MissingE_askFixes_scroll",1) == 1) {
            activeScripts.askFixes = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "askFixes/askboxScroll.css", allFrames: true});
         }
         else
            activeScripts.askFixes = false;
      }
      if (sender.tab.url == request.url &&
          ((/http:\/\/www\.tumblr\.com\/new\//.test(sender.tab.url) ||
            /http:\/\/www\.tumblr\.com\/tumblelog\/[0-9A-Za-z\-\_]+\/new\//.test(sender.tab.url) ||
            /http:\/\/www\.tumblr\.com\/reblog\//.test(sender.tab.url) ||
            /http:\/\/www\.tumblr\.com\/edit\/[0-9]+/.test(sender.tab.url)) ||
         (/http:\/\/www\.tumblr\.com\/messages/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/inbox/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/tumblelog\/[A-Za-z0-9\-\_]+\/messages/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/submissions/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/tumblelog\/[A-Za-z0-9\-\_]+\/submissions/.test(sender.tab.url)) ||
         (/http:\/\/www\.tumblr\.com\/share/.test(sender.tab.url)))) {

         if (getStorage("MissingE_postingFixes_enabled",1) == 1) {
            activeScripts.postingFixes = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "postingFixes/postingFixes.js"});
            chrome.tabs.insertCSS(sender.tab.id, {file: "postingFixes/postingFixes.css"});
         }
         else
            activeScripts.postingFixes = false;

         if (getStorage("MissingE_betterReblogs_enabled",1) == 1) {
            activeScripts.betterReblogs = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "betterReblogs/betterReblogs_fill.js"});
         }
         else
            activeScripts.betterReblogs = false;
      }
      if (/http:\/\/www\.tumblr\.com\/dashboard\/iframe/.test(request.url) &&
          !(/http:\/\/www\.tumblr\.com\/edit\/[0-9]+/.test(sender.tab.url)) &&
          !(/http:\/\/www\.tumblr\.com\/tumblelog\/[A-Za-z0-9\-\_]+\/new\//.test(sender.tab.url)) &&
          !(/http:\/\/www\.tumblr\.com\/new\//.test(sender.tab.url))) {
         chrome.tabs.insertCSS(sender.tab.id, {file: "common/endlessPages.css", allFrames:true});
         if (getStorage("MissingE_gotoDashPost_enabled",1) == 1) {
            activeScripts.gotoDashPost = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "gotoDashPost/gotoDashPost.js", allFrames: true});
         }
         else
            activeScripts.gotoDashPost = false;

         if (getStorage("MissingE_reblogYourself_enabled",1) == 1 &&
             getStorage("MissingE_reblogYourself_postPage",1) == 1) {
            activeScripts.reblogYourself = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "reblogYourself/reblogYourself_post.js", allFrames: true});
         }
         else
            activeScripts.reblogYourself = false;

         if (getStorage("MissingE_betterReblogs_enabled",1) == 1 &&
             getStorage("MissingE_betterReblogs_passTags",1) == 1) {
            activeScripts.betterReblogs = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "betterReblogs/betterReblogs_post.js", allFrames: true});
         }
         else
            activeScripts.betterReblogs = false;
      }
      if (sender.tab.url == request.url &&
          (/http:\/\/www\.tumblr\.com\/dashboard/.test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/tumblelog/.test(sender.tab.url))) {
         if (getStorage("MissingE_replyReplies_enabled",1) == 1) {
            activeScripts.replyReplies = true;
            chrome.tabs.insertCSS(sender.tab.id, {code: "#posts .notification .notification_type_icon { background-image:url('" + chrome.extension.getURL('replyReplies/notification_icons.png') + "') !important; } #posts ol.notes .notification_type_icon { background-image:url('" + chrome.extension.getURL('replyReplies/notes_icons.png') + "') !important; }"});
            chrome.tabs.insertCSS(sender.tab.id, {file: "replyReplies/replyReplies.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "replyReplies/replyReplies.js"});
         }
         else
            activeScripts.replyReplies = false;
      }
      if (sender.tab.url == request.url &&
          /http:\/\/www\.tumblr\.com\/(tumblelog\/[^\/]*\/)?new\/(text|photo)/.test(sender.tab.url)) {
         if (getStorage("MissingE_replyReplies_enabled",1) == 1) {
            activeScripts.replyReplies = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "replyReplies/replyReplies_fill.js"});
         }
         else
            activeScripts.replyReplies = false;
      }
      if (sender.tab.url == request.url &&
          /http:\/\/www\.tumblr\.com\/following/.test(sender.tab.url)) {
         if (getStorage("MissingE_postCrushes_enabled",1) == 1) {
            activeScripts.postCrushes = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "postCrushes/postCrushes.js"});
         }
         else
            activeScripts.postCrushes = false;
      }
      if (sender.tab.url == request.url &&
          /http:\/\/www\.tumblr\.com\/new\/photo/.test(sender.tab.url)) {
         if (getStorage("MissingE_postCrushes_enabled",1) == 1) {
            activeScripts.postCrushes = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "postCrushes/postCrushes_fill.js"});
         }
         else
            activeScripts.postCrushes = false;
      }
      if (sender.tab.url == request.url &&
          (/http:\/\/www\.tumblr\.com\/(submissions|messages|inbox)/
            .test(sender.tab.url) ||
           /http:\/\/www\.tumblr\.com\/tumblelog\/[^\/]*\/(submissions|messages)/
            .test(sender.tab.url))) {
         if (getStorage("MissingE_askFixes_enabled",1) == 1) {
            activeScripts.askFixes = true;
            chrome.tabs.insertCSS(sender.tab.id, {file: "askFixes/askFixes.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "askFixes/askFixes.js"});
         }
         else {
            activeScripts.askFixes = false;
         }
      }
      if (sender.tab.url == request.url &&
          (/http:\/\/www\.tumblr\.com\/dashboard/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/tumblelog/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/likes/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/liked\/by\//.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/tagged\//.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/(submissions|messages|inbox)/.test(sender.tab.url)) &&
          !(/http:\/\/www\.tumblr\.com\/tumblelog\/[^\/]*\/(drafts|queue)/.test(sender.tab.url)) &&
          !(/http:\/\/www\.tumblr\.com\/tumblelog\/[^\/]*\/new\//.test(sender.tab.url))) {
         if (getStorage("MissingE_timestamps_enabled",1) == 1) {
            activeScripts.timestamps = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "timestamps/timestamps.js"});
         }
         else
            activeScripts.timestamps = false;
      }
      if (sender.tab.url == request.url &&
          (/http:\/\/www\.tumblr\.com\/dashboard/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/tumblelog/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/likes/.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/liked\/by\//.test(sender.tab.url) ||
          /http:\/\/www\.tumblr\.com\/tagged\//.test(sender.tab.url)) &&
          !(/http:\/\/www\.tumblr\.com\/tumblelog\/[^\/]*\/(submissions|messages|drafts|queue)/.test(sender.tab.url)) &&
          !(/http:\/\/www\.tumblr\.com\/tumblelog\/[^\/]*\/new\//.test(sender.tab.url))) {
         if (getStorage("MissingE_magnifier_enabled",1) == 1) {
            activeScripts.magnifier = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "magnifier/magnifier.js"});
            chrome.tabs.insertCSS(sender.tab.id, {file: "magnifier/magnifier.css"});
         }
         else
            activeScripts.magnifier = false;

         if (getStorage("MissingE_betterReblogs_enabled",1) == 1) {
            activeScripts.betterReblogs = true;
            if (getStorage("MissingE_betterReblogs_quickReblog",0) == 1) {
               zindexFix = true;
            }
            chrome.tabs.insertCSS(sender.tab.id, {file: "betterReblogs/quickReblog.css"});
            chrome.tabs.executeScript(sender.tab.id, {file: "betterReblogs/betterReblogs_dash.js"});
         }
         else
            activeScripts.betterReblogs = false;

         if (getStorage("MissingE_reblogYourself_enabled",1) == 1 &&
             getStorage("MissingE_reblogYourself_dashboard",1) == 1) {
            activeScripts.reblogYourself = true;
            chrome.tabs.executeScript(sender.tab.id, {file: "reblogYourself/reblogYourself_dash.js"});
         }
         else
            activeScripts.reblogYourself = false;
      }

      if (zindexFix) {
         chrome.tabs.executeScript(sender.tab.id, {file: "common/zindexFix.js"});
      }

      activeScripts.url = request.url;
      sendResponse(JSON.stringify(activeScripts));
   }
});

function moveSetting(oldpref, newpref) {
   var pref;
   if ((pref = localStorage[oldpref])) {
      console.log('"' + oldpref + '" depracated. Moving setting to "' + newpref + '"');
      localStorage[newpref] = pref;
      localStorage.removeItem(oldpref);
   }
}

function getVersion() {
   var xhr = new XMLHttpRequest();
   xhr.open('GET', chrome.extension.getURL('manifest.json'), false);
   xhr.send(null);
   var manifest = JSON.parse(xhr.responseText);
   return manifest.version;
}

function onStart(currVersion, prevVersion) {
   if (prevVersion && prevVersion !== currVersion) {
      console.log("Updated Missing e (" +
                  prevVersion + " => " + currVersion +
                  ")");
      setStorage('MissingE_compatCheck',0);
   }
   else if (!prevVersion) {
      console.log("Installed Missing e " + currVersion);
      setStorage('MissingE_compatCheck',0);
   }
   setStorage('MissingE_version',currVersion);
}

var currVersion = getVersion();
var prevVersion = getStorage('MissingE_version',null);
onStart(currVersion, prevVersion);

moveSetting('MissingE_dashboardFixes_slimSidebar','MissingE_sidebarTweaks_slimSidebar');
moveSetting('MissingE_dashboardFixes_followingLink','MissingE_sidebarTweaks_followingLink');

var fivedays = 432000000;
var now = (new Date()).valueOf();
if (now >= parseInt(getStorage("MissingE_compatCheck",0)) + fivedays) {
   localStorage.setItem("MissingE_compatCheck",now);
   chrome.management.getAll(function(arr) {
      var repl = new Array();
      var ids = new Array();
      for (i=0; i<arr.length; i++) {
         if (arr[i].enabled) {
            switch (arr[i].name) {
               case "Tumblr - Photo Replies Always":
               case "Tumblr post - Upload Photo for all posts":
               case "Tumblr Bookmarker":
               case "Tumblr Dash Links To Tabs":
               case "Tumblr Follow Checkr":
               case "Tumblr Goto Dash Post":
               case "Tumblr Post Crushes":
               case "Tumblr Reblog Yourself":
               case "Tumblr Reply Replies":
               case "Tumblr SafeDash":
               case "Tumblr Timestamps":
               case "Tumblr Unfollowr":
               case "Tumblr Sidebr":
                  repl.push(arr[i].name);
                  ids.push(arr[i].id);
                  break;
            }
         }
      }

      if (repl.length > 0) {
         var msg = "======\n Missing e\n======\n\n" +
                   "Functionality of the following installed scripts has been replaced by the 'Missing e' extension. " +
                   "Using them may cause compatibility problems.\n\n" +
                   " - " + repl.join("\n - ") +
                   "\n\nDo you want to disable them?\n\nYou can re-enable or uninstall them later in your " +
                   "Extensions menu.\n\nSee http://missinge.infraware.ca/faq for more information.";
         var answer = confirm(msg);
         if (answer) {
            for (i=0; i<ids.length; i++) {
               chrome.management.setEnabled(ids[i], false);
               if (repl[i] === "Tumblr Sidebr") {
                  setStorage("MissingE_sidebarTweaks_addSidebar",1);
               }
            }
         }
      }
   });
}
</script>
</head>
</html>
