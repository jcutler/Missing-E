<!--
 - 'Missing e' Extension
 -
 - Copyright 2011, Jeremy Cutler
 - Released under the GPL version 3 licence.
 - SEE: GPL-LICENSE.txt
 -
 - This file is part of 'Missing e'.
 -
 - 'Missing e' is free software: you can redistribute it and/or modify
 - it under the terms of the GNU General Public License as published by
 - the Free Software Foundation, either version 3 of the License, or
 - (at your option) any later version.
 -
 - 'Missing e' is distributed in the hope that it will be useful,
 - but WITHOUT ANY WARRANTY; without even the implied warranty of
 - MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 - GNU General Public License for more details.
 -
 - You should have received a copy of the GNU General Public License
 - along with 'Missing e'.  If not, see [http://www.gnu.org/licenses/].
-->
<html>
<head>
<script type="text/javascript" src="common/jquery-1.5.min.js"></script>
<script type="text/javascript" src="common/defs.js"></script>
<script type="text/javascript" src="common/utils.js"></script>
<script>
var componentList = ["dashboardFixes",
                     "bookmarker",
                     "dashLinksToTabs",
                     "safeDash",
                     "timestamps",
                     "magnifier",
                     "betterReblogs",
                     "gotoDashPost",
                     "postingFixes",
                     "reblogYourself",
                     "askFixes",
                     "followChecker",
                     "postCrushes",
                     "replyReplies",
                     "unfollower"];

var maxActiveAjax = 15;
var activeAjax = 0;
/*
var activeRequests = {};
var onHold = {};
var numSleeping = 0;
*/
var waitQueue = [];
var cache = {};
var cacheElements = 0;
var cacheClear;
var clearQueues;
var fiveMinutes = 300000;
var tenSeconds = 10000;
var debugMode = false;

function getStorage(key, defVal) {
   var retval = safari.extension.settings[key];
   if (retval === undefined || retval === null || retval === "") {
      return defVal;
   }
   else {
      if (/[^0-9]/.test(retval)) {
         return retval;
      }
      else {
         return parseInt(retval, 10);
      }
   }
}

function setStorage(key, val) {
   safari.extension.settings[key] = val;
}

cacheClear = setInterval(function() {
   cache = {};
   cacheElements = 0;
}, fiveMinutes);
clearQueues = setInterval(function() {
   if (activeAjax == 0) {
      /* Not working
      wakeAll();
      */
      dequeueAjax();
   }
}, tenSeconds);

function debug(msg) {
   if (debugMode) {
      console.log(msg);
   }
}

function doTags(stamp, id, request) {
   var tags = stamp["tags"];
   if (!tags) {
      tags = [];
   }
   request.target.page.dispatchMessage("tags",{success: true, data: tags});
}

function doTimestamp(stamp, id, request) {
   var ts = stamp["unix-timestamp"];
   var d = new Date(ts*1000);
   var ins = getStorage("MissingE_timestamps_format","%Y-%m-%D %H:%i");
   ins = getFormattedDate(d, ins);
   request.target.page.dispatchMessage("timestamp",{pid: id, success: true, data: ins});
}

function doReblogDash(stamp, id, request) {
   var key = stamp["reblog-key"];
   var replaceIcons = getStorage("MissingE_dashboardFixes_enabled",1) == 1 &&
                      getStorage("MissingE_dashboardFixes_replaceIcons",1) == 1;
   request.target.page.dispatchMessage("reblogYourself",{pid: id, success: true, data: key, icons: replaceIcons});
}

function doMagnifier(stamp, id, request) {
   var url;
   if (stamp.photos.length > 0) {
      url = new Array();
      for (i=0; i<stamp.photos.length; i++) {
         url.push(stamp.photos[i]["photo-url-1280"]);
         var cap = stamp.photos[i]["caption"];
         if (cap == undefined || cap == null)
            url.push("");
         else
            url.push(cap);
      }
      url = JSON.stringify(url);
   }
   else {
      url = stamp["photo-url-1280"];
   }
   request.target.page.dispatchMessage("magnifier", {pid: id, success: true, data: url});
}

function queueAjax(details) {
   waitQueue.push(details);
   debug("Queueing " + details.type + " request. " + (waitQueue.length) +
         " in queue");
}

function runItem(call) {
   if (call.type === "magnifier") {
      requestMagnifier(call.request);
   }
   else if (call.type === "reblogYourself") {
      requestReblogYourself(call.request);
   }
   else if (call.type === "timestamp") {
      requestTimestamp(call.request);
   }
   else if (call.type === "tags") {
      requestTags(call.request);
   }
}

function dequeueAjax(id) {
   if (id) {
      activeAjax--;
      /* Not working
      wakeById(id);
      delete activeRequests[id];
      */
   }
   while (activeAjax < maxActiveAjax) {
      var call = waitQueue.shift();
      if (!call) { return false; }
      debug("Dequeueing " + call.type + " request. " + (waitQueue.length) +
            " in queue");
      runItem(call);
   }
}

function saveCache(id, entry) {
   cacheElements++;
   for (var i in entry) {
      if (i !== "photos" &&
          i !== "photo-url-1280" &&
          i !== "unix-timestamp" &&
          i !== "reblog-key" &&
          i !== "url" &&
          i !== "tags") {
         delete entry[i];
      }
   }
   cache[id] = entry;
}

function cacheServe(type, id, request, fn, midFlight) {
   var entry;
   if ((entry = cache[id])) {
      debug(type + " request (" + id + ") served from cache.");
      if (midFlight) {
         dequeueAjax(id);
      }
      else {
         dequeueAjax();
      }
      fn(entry, id, request);
      return true;
   }
   else {
      return false;
   }
}

/* Not working
function wakeAll() {
   var call;
   for (var i in onHold) {
      call = onHold[i];
      delete onHold[i];
      numSleeping --;
      debug("Waking " + call.type + " request (" + call.request.pid + "). " + numSleeping + " still asleep");
      runItem(call);
   }
}

function wakeById(id) {
   var i,j;
   for (i=0; activeRequests[id] && i<activeRequests[id].length; i++) {
      var call;
      if ((call = activeRequests[id][i])) {
         delete onHold[call.type + call.request.message.pid];
         numSleeping--;
         debug("Selectively waking " + call.type + " request (" + call.request.pid + "). " + numSleeping + " still asleep");
         runItem(call);
      }
   }
}
*/

function isRequested(details) {
   return false;
   /* Not working
   var bucket;
   if ((bucket = activeRequests[details.request.message.pid])) {
      onHold[details.type + details.request.message.pid] = details;
      bucket.push(details);
      numSleeping++;
      debug("Sleeping " + details.type + " request (" + details.request.pid + "). " + numSleeping + " asleep");
      return true;
   }
   else {
      return false;
   }
   */
}

function startAjax(id) {
   activeAjax++;
   /* Not working
   activeRequests[id] = [];
   */
}

function requestTags(request) {
   if (request.target.page === undefined) {
      debug("Stop tags request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("tags", request, request.message.pid, doTags,
                  false)) {
      return true;
   }
   else if (isRequested({type: "tags", request: request})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "tags", request: request});
   }
   else {
      debug("AJAX tags request (" + request.message.pid + ")");
      startAjax(request.message.pid);
      $.ajax({
         type: "GET",
         url: request.message.url + "/api/read/json?id=" + request.message.pid,
         dataType: "text",
         tryCount: 0,
         retryLimit: getStorage("MissingE_betterReblogs_retries",defaultRetries),
         targetId: request.message.pid,
         error: function(xhr, textStatus) {
            if (request.target.page === undefined) {
               debug("Stop tags request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe("tags", request, request.message.pid,
                           doTags, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  debug("Retry tags request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  debug("tags request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  request.target.page.dispatchMessage("tags",{success: false});
               }
            }
         },
         success: function(data, textStatus) {
            if (!(/^\s*var\s+tumblr_api_read/.test(data))) {
               if (request.target.page === undefined) {
                  debug("Stop tags request: Tab closed or changed.");
                  dequeueAjax(this.targetId);
                  return;
               }
               if (cacheServe("tags", request, request.message.pid,
                              doTags, true)) {
                  return true;
               }
               else {
                  this.tryCount++;
                  if (this.tryCount <= this.retryLimit) {
                     debug("Retry tags request (" + this.targetId + ")");
                     $.ajax(this);
                     return;
                  }
                  else {
                     debug("tags request (" + this.targetId + ") failed");
                     dequeueAjax(this.targetId);
                     request.target.page.dispatchMessage("tags",{success: false});
                  }
               }
            }
            else {
               var txt = data.replace(/^\s*var\s+tumblr_api_read\s+=\s+/,'').replace(/;\s*$/,'');
               var stamp = JSON.parse(txt);
               var info = stamp["posts"][0];
               saveCache(this.targetId, info);
               dequeueAjax(this.targetId);
               if (request.target.page !== undefined) {
                  doTags(info, this.targetId, request);
               }
            }
         }
      });
   }
}

function requestTimestamp(request) {
   if (request.target.page === undefined) {
      debug("Stop timestamp request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("timestamp", request, request.message.pid, doTimestamp,
                  false)) {
      return true;
   }
   else if (isRequested({type: "timestamp", request: request})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "timestamp", request: request});
   }
   else {
      debug("AJAX timestamp request (" + request.message.pid + ")");
      startAjax(request.message.pid);
      $.ajax({
         type: "GET",
         url: request.message.url + "/api/read/json?id=" + request.message.pid,
         dataType: "text",
         tryCount: 0,
         retryLimit: getStorage("MissingE_timestamps_retries",defaultRetries),
         targetId: request.message.pid,
         error: function(xhr, textStatus) {
            if (request.target.page === undefined) {
               debug("Stop timestamp request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe("timestamp", request, request.message.pid,
                           doTimestamp, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  debug("Retry timestamp request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  debug("timestamp request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  request.target.page.dispatchMessage("timestamp",{pid: this.targetId, success: false});
               }
            }
         },
         success: function(data, textStatus) {
            if (!(/^\s*var\s+tumblr_api_read/.test(data))) {
               if (request.target.page === undefined) {
                  debug("Stop timestamp request: Tab closed or changed.");
                  dequeueAjax(this.targetId);
                  return;
               }
               if (cacheServe("timestamp", request, request.message.pid,
                              doTimestamp, true)) {
                  return true;
               }
               else {
                  this.tryCount++;
                  if (this.tryCount <= this.retryLimit) {
                     debug("Retry timestamp request (" + this.targetId + ")");
                     $.ajax(this);
                     return;
                  }
                  else {
                     debug("timestamp request (" + this.targetId + ") failed");
                     dequeueAjax(this.targetId);
                     request.target.page.dispatchMessage("timestamp",{pid: this.targetId, success: false});
                  }
               }
            }
            else {
               var txt = data.replace(/^\s*var\s+tumblr_api_read\s+=\s+/,'').replace(/;\s*$/,'');
               var stamp = JSON.parse(txt);
               var info = stamp["posts"][0];
               saveCache(this.targetId, info);
               dequeueAjax(this.targetId);
               if (request.target.page !== undefined) {
                  doTimestamp(info, this.targetId, request);
               }
            }
         }
      });
   }
}

function requestReblogYourself(request) {
   if (request.target.page === undefined) {
      debug("Stop reblogYourself request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("reblogYourself", request.message.pid, request,
                  doReblogDash, false)) {
      return true;
   }
   else if (isRequested({type: "reblogYourself", request: request})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "reblogYourself", request: request});
   }
   else {
      debug("AJAX reblogYourself request (" + request.message.pid + ")");
      startAjax(request.message.pid);
      $.ajax({
         type: "GET",
         url: request.message.url + "/api/read/json?id=" + request.message.pid,
         dataType: "text",
         tryCount: 0,
         retryLimit: getStorage("MissingE_reblogYourself_retries",defaultRetries),
         targetId: request.message.pid,
         error: function(xhr, textStatus) {
            if (request.target.page === undefined) {
               debug("Stop reblogYourself request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe("reblogYourself", request.message.pid, request,
                  doReblogDash, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  debug("Retry reblogYourself request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  debug("reblogYourself request (" + this.targetId +
                        ") failed");
                  dequeueAjax(this.targetId);
                  var replaceIcons = getStorage("MissingE_dashboardFixes_enabled",1) == 1 &&
                                       getStorage("MissingE_dashboardFixes_replaceIcons",1) == 1;
                  request.target.page.dispatchMessage("reblogYourself",{pid: this.targetId, success: false, icons: replaceIcons});
               }
            }
         },
         success: function(data, textStatus) {
            if (!(/^\s*var\s+tumblr_api_read/.test(data))) {
               if (request.target.page === undefined) {
                  debug("Stop reblogYourself request: Tab closed or changed.");
                  dequeueAjax(this.targetId);
                  return;
               }
               if (cacheServe("reblogYourself", request.message.pid, request,
                     doReblogDash, true)) {
                  return true;
               }
               else {
                  this.tryCount++;
                  if (this.tryCount <= this.retryLimit) {
                     debug("Retry reblogYourself request (" + this.targetId +
                           ")");
                     $.ajax(this);
                     return;
                  }
                  else {
                     debug("reblogYourself request (" + this.targetId +
                           ") failed");
                     dequeueAjax(this.targetId);
                     var replaceIcons = getStorage("MissingE_dashboardFixes_enabled",1) == 1 &&
                                          getStorage("MissingE_dashboardFixes_replaceIcons",1) == 1;
                     request.target.page.dispatchMessage("reblogYourself",{pid: this.targetId, success: false, icons: replaceIcons});
                  }
               }
            }
            else {
               var txt = data.replace(/^\s*var\s+tumblr_api_read\s+=\s+/,'').replace(/;\s*$/,'');
               var stamp = JSON.parse(txt);
               var info = stamp["posts"][0];
               saveCache(this.targetId, info);
               dequeueAjax(this.targetId);
               if (request.target.page !== undefined) {
                  doReblogDash(info, this.targetId, request);
               }
            }
         }
      });
   }
}

function requestMagnifier(request) {
   if (request.target.page === undefined) {
      debug("Stop magnifier request: Tab closed or changed.");
      dequeueAjax();
      return;
   }
   else if (cacheServe("magnifier", request.message.pid, request, doMagnifier,
                  false)) {
      return true;
   }
   else if (isRequested({type: "magnifier", request: request})) {
      return true;
   }
   else if (activeAjax >= maxActiveAjax) {
      queueAjax({type: "magnifier", request: request});
   }
   else {
      debug("AJAX magnifier request (" + request.message.pid + ")");
      startAjax(request.message.pid);
      $.ajax({
         type: "GET",
         url: request.message.url + "/api/read/json?id=" + request.message.pid,
         dataType: "text",
         tryCount: 0,
         retryLimit: getStorage("MissingE_magnifier_retries",defaultRetries),
         targetId: request.message.pid,
         error: function(xhr, textStatus) {
            if (request.target.page === undefined) {
               debug("Stop magnifier request: Tab closed or changed.");
               dequeueAjax(this.targetId);
               return;
            }
            if (cacheServe("magnifier", request.message.pid, request,
                           doMagnifier, true)) {
               return true;
            }
            else {
               this.tryCount++;
               if (this.tryCount <= this.retryLimit) {
                  debug("Retry magnifier request (" + this.targetId + ")");
                  $.ajax(this);
                  return;
               }
               else {
                  debug("magnifier request (" + this.targetId + ") failed");
                  dequeueAjax(this.targetId);
                  request.target.page.dispatchMessage("magnifier", {pid: this.targetId, success: false});
               }
            }
         },
         success: function(data, textStatus) {
            if (!(/^\s*var\s+tumblr_api_read/.test(data))) {
               if (request.target.page === undefined) {
                  debug("Stop magnifier request: Tab closed or changed.");
                  dequeueAjax(this.targetId);
                  return;
               }
               if (cacheServe("magnifier", request.message.pid, request,
                              doMagnifier, true)) {
                  return true;
               }
               else {
                  this.tryCount++;
                  if (this.tryCount <= this.retryLimit) {
                     debug("Retry magnifier request (" + this.targetId + ")");
                     $.ajax(this);
                     return;
                  }
                  else {
                     debug("magnifier request (" + this.targetId + ") failed");
                     dequeueAjax(this.targetId);
                     request.target.page.dispatchMessage("magnifier", {pid: this.targetId, success: false});
                  }
               }
            }
            else {
               var txt = data.replace(/^\s*var\s+tumblr_api_read\s+=\s+/,'').replace(/;\s*$/,'');
               var stamp = JSON.parse(txt);
               var info = stamp["posts"][0];
               saveCache(this.targetId, info);
               dequeueAjax(this.targetId);
               if (request.target.page !== undefined) {
                  doMagnifier(info, this.targetId, request);
               }
            }
         }
      });
   }
}

safari.application.addEventListener("command", performCommand, false);
function performCommand(cmd) {
   if (cmd.command == "missinge-settings") {
      cmd.target.browserWindow.openTab().url = safari.extension.baseURI + "options.html"
   }
}

safari.application.addEventListener("message", handleRequest, false);
function handleRequest(request) {
   if (request.name == "open") {
      request.target.browserWindow.openTab().url = request.message;
   }
   else if (request.name == "close-options") {
      var i,j;
      var windows = safari.application.browserWindows;
      for (i=0; i<windows.length; i++) {
         for (j=0; j<windows[i].tabs.length; j++) {
            if (windows[i].tabs[j].url === request.target.url &&
                windows[i].tabs[j] !== request.target) {
               windows[i].tabs[j].close();
            }
         }
      }
   }
   else if (request.name == "magnifier") {
      requestMagnifier(request);
   }
   else if (request.name == "reblogYourself") {
      requestReblogYourself(request);
   }
   else if (request.name == "timestamp") {
      requestTimestamp(request);
   }
   else if (request.name == "tags") {
      requestTags(request);
   }
   else if (request.name == "change-setting") {
      setStorage(request.message.name, request.message.val);
   }
   else if (request.name == "all-settings") {
      var settings = {};
      settings.MissingE_experimentalFeatures_enabled = getStorage("MissingE_experimentalFeatures_enabled",0);
      for (i=0; i<componentList.length; i++) {
         settings["MissingE_" + componentList[i] + "_enabled"] = getStorage("MissingE_" + componentList[i] +
                                                                            "_enabled", 1);
      }
      settings.MissingE_dashboardFixes_reblogQuoteFit = getStorage("MissingE_dashboardFixes_reblogQuoteFit",1);
      settings.MissingE_dashboardFixes_wrapTags = getStorage("MissingE_dashboardFixes_wrapTags",1);
      settings.MissingE_dashboardFixes_replaceIcons = getStorage("MissingE_dashboardFixes_replaceIcons",1);
      settings.MissingE_dashboardFixes_timeoutAJAX = getStorage("MissingE_dashboardFixes_timeoutAJAX",1);
      settings.MissingE_dashboardFixes_timeoutLength = getStorage("MissingE_dashboardFixes_timeoutLength",defaultTimeout);
      settings.MissingE_dashboardFixes_postLinks = getStorage("MissingE_dashboardFixes_postLinks",1);
      settings.MissingE_dashboardFixes_reblogReplies = getStorage("MissingE_dashboardFixes_reblogReplies",0);
      settings.MissingE_magnifier_retries = getStorage("MissingE_magnifier_retries",defaultRetries);
      settings.MissingE_dashLinksToTabs_newPostTabs = getStorage("MissingE_dashLinksToTabs_newPostTabs",1);
      settings.MissingE_dashLinksToTabs_sidebar = getStorage("MissingE_dashLinksToTabs_sidebar",0);
      settings.MissingE_dashLinksToTabs_reblogLinks = getStorage("MissingE_dashLinksToTabs_reblogLinks",0);
      settings.MissingE_dashLinksToTabs_editLinks = getStorage("MissingE_dashLinksToTabs_editLinks",0);
      settings.MissingE_timestamps_retries = getStorage("MissingE_timestamps_retries",defaultRetries);
      settings.MissingE_timestamps_format = getStorage("MissingE_timestamps_format","%Y-%m-%D %H:%i");
      settings.MissingE_postingFixes_photoReplies = getStorage("MissingE_postingFixes_photoReplies",1);
      settings.MissingE_postingFixes_uploaderToggle = getStorage("MissingE_postingFixes_uploaderToggle",1);
      settings.MissingE_postingFixes_addUploader = getStorage("MissingE_postingFixes_addUploader",1);
      settings.MissingE_postingFixes_quickButtons = getStorage("MissingE_postingFixes_quickButtons",1);
      settings.MissingE_reblogYourself_postPage = getStorage("MissingE_reblogYourself_postPage",1);
      settings.MissingE_reblogYourself_dashboard = getStorage("MissingE_reblogYourself_dashboard",1);
      settings.MissingE_reblogYourself_retries = getStorage("MissingE_reblogYourself_retries",defaultRetries);
      settings.MissingE_followChecker_retries = getStorage("MissingE_followChecker_retries",defaultRetries);
      settings.MissingE_postCrushes_prefix = getStorage("MissingE_postCrushes_prefix","Tumblr Crushes:");
      settings.MissingE_postCrushes_crushSize = getStorage("MissingE_postCrushes_crushSize",1);
      settings.MissingE_postCrushes_addTags = getStorage("MissingE_postCrushes_addTags",1);
      settings.MissingE_postCrushes_showPercent = getStorage("MissingE_postCrushes_showPercent",1);
      settings.MissingE_replyReplies_showAvatars = getStorage("MissingE_replyReplies_showAvatars",1);
      settings.MissingE_replyReplies_smallAvatars = getStorage("MissingE_replyReplies_smallAvatars",1);
      settings.MissingE_replyReplies_addTags = getStorage("MissingE_replyReplies_addTags",1);
      settings.MissingE_replyReplies_newTab = getStorage("MissingE_replyReplies_newTab",1);
      settings.MissingE_unfollower_retries = getStorage("MissingE_unfollower_retries",defaultRetries);
      settings.MissingE_betterReblogs_passTags = getStorage("MissingE_betterReblogs_passTags",1);
      settings.MissingE_betterReblogs_retries = getStorage("MissingE_betterReblogs_retries",defaultRetries);
      settings.MissingE_betterReblogs_autoFillTags = getStorage("MissingE_betterReblogs_autoFillTags",1);
      settings.MissingE_betterReblogs_quickReblog = getStorage("MissingE_betterReblogs_quickReblog",1);
      request.target.page.dispatchMessage("all-settings",settings);
   }
   else if (request.name == "settings") {
      var settings = {};
      settings.component = request.message.component;
      settings.subcomponent = request.message.subcomponent;
      settings.experimental = getStorage("MissingE_experimentalFeatures_enabled",0);
      switch(request.message.component) {
         case "dashboardFixes":
            settings.reblogQuoteFit = getStorage("MissingE_dashboardFixes_reblogQuoteFit",1);
            settings.wrapTags = getStorage("MissingE_dashboardFixes_wrapTags",1);
            settings.replaceIcons = getStorage("MissingE_dashboardFixes_replaceIcons",1);
            settings.timeoutAJAX = getStorage("MissingE_dashboardFixes_timeoutAJAX",1);
            settings.timeoutLength = getStorage("MissingE_dashboardFixes_timeoutLength",defaultTimeout);
            settings.postLinks = getStorage("MissingE_dashboardFixes_postLinks",1);
            settings.reblogReplies = getStorage("MissingE_dashboardFixes_reblogReplies",0);
            break;
         case "dashLinksToTabs":
            settings.newPostTabs = getStorage("MissingE_dashLinksToTabs_newPostTabs",1);
            settings.sidebar = getStorage("MissingE_dashLinksToTabs_sidebar",0);
            settings.reblogLinks = getStorage("MissingE_dashLinksToTabs_reblogLinks",0);
            settings.editLinks = getStorage("MissingE_dashLinksToTabs_editLinks",0);
            break;
         case "replyReplies":
            settings.showAvatars = getStorage("MissingE_replyReplies_showAvatars",1);
            settings.smallAvatars = getStorage("MissingE_replyReplies_smallAvatars",1);
            settings.addTags = getStorage("MissingE_replyReplies_addTags",1);
            settings.newTab = getStorage("MissingE_replyReplies_newTab",1);
            break;
         case "postCrushes_fill":
         case "postCrushes":
            settings.prefix = getStorage("MissingE_postCrushes_prefix","Tumblr Crushes:");
            settings.crushSize = getStorage("MissingE_postCrushes_crushSize",1);
            settings.addTags = getStorage("MissingE_postCrushes_addTags",1);
            settings.showPercent = getStorage("MissingE_postCrushes_showPercent",1);
            break;
         case "postingFixes":
            settings.photoReplies = getStorage("MissingE_postingFixes_photoReplies",1);
            settings.uploaderToggle = getStorage("MissingE_postingFixes_uploaderToggle",1);
            settings.addUploader = getStorage("MissingE_postingFixes_addUploader",1);
            settings.quickButtons = getStorage("MissingE_postingFixes_quickButtons",1);
            break;
         case "unfollower":
         case "followChecker":
            settings.retries = getStorage("MissingE_" + request.component + "_retries",defaultRetries);
            break;
         case "betterReblogs":
            settings.passTags = getStorage("MissingE_betterReblogs_passTags",1);
            settings.autoFillTags = getStorage("MissingE_betterReblogs_autoFillTags",1);
            settings.quickReblog = getStorage("MissingE_betterReblogs_quickReblog",1);
            break;
      }
      request.target.page.dispatchMessage("settings",settings);
   }
   else if (request.name == "start") {
      var activeScripts = {};
      if (!request.message.isFrame &&
          (/http:\/\/www\.tumblr\.com\/dashboard/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/drafts/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/likes/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/liked\/by\//.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/submissions/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/messages/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/queue/.test(request.message.url) ||
          (/http:\/\/www\.tumblr\.com\/tumblelog/.test(request.message.url) &&
           !(/http:\/\/www\.tumblr\.com\/tumblelog\/[^\/]*\/new\//
             .test(request.message.url))) ||
          /http:\/\/www\.tumblr\.com\/tagged\//.test(request.message.url))) {
         if (getStorage("MissingE_dashLinksToTabs_enabled",1) == 1) {
            activeScripts.dashLinksToTabs = true;
         }
         else
            activeScripts.dashLinksToTabs = false;

         if (getStorage("MissingE_safeDash_enabled",1) == 1) {
            activeScripts.safeDash = true;
         }
         else
            activeScripts.safeDash = false;

         if (getStorage("MissingE_bookmarker_enabled",1) == 1) {
            activeScripts.bookmarker = true;
         }
         else
            activeScripts.bookmarker = false;

         if (getStorage("MissingE_unfollower_enabled",1) == 1 ||
             getStorage("MissingE_followChecker_enabled",1) == 1) {
         }

         if (getStorage("MissingE_unfollower_enabled",1) == 1) {
            activeScripts.unfollower = true;
         }
         else
            activeScripts.unfollower = false;

         if (getStorage("MissingE_followChecker_enabled",1) == 1) {
            activeScripts.followChecker = true;
         }
         else
            activeScripts.followChecker = false;

         if (getStorage("MissingE_dashboardFixes_enabled",1) == 1) {
            activeScripts.dashboardFixes = true;
         }
         else
            activeScripts.dashboardFixes = false;
      }
      if (/http:\/\/www\.tumblr\.com\/ask_form\//.test(request.message.url)) {
         if (getStorage("MissingE_askFixes_enabled",1) == 1) {
            activeScripts.askFixes = true;
         }
         else
            activeScripts.askFixes = false;
      }
      if (!request.message.isFrame &&
          ((request.message.bodyId == 'dashboard_edit_post' &&
            (/http:\/\/www\.tumblr\.com\/new\//.test(request.message.url) ||
             /http:\/\/www\.tumblr\.com\/tumblelog\/[0-9A-Za-z\-\_]+\/new\//.test(request.message.url) ||
             /http:\/\/www\.tumblr\.com\/reblog\//.test(request.message.url) ||
             /http:\/\/www\.tumblr\.com\/edit\/[0-9]+/.test(request.message.url))) ||
         (/http:\/\/www\.tumblr\.com\/messages/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/tumblelog\/[A-Za-z0-9\-\_]+\/messages/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/submissions/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/tumblelog\/[A-Za-z0-9\-\_]+\/submissions/.test(request.message.url)) ||
         (/http:\/\/www\.tumblr\.com\/share/.test(request.message.url)))) {
         if (getStorage("MissingE_postingFixes_enabled",1) == 1) {
            activeScripts.postingFixes = true;
         }
         else
            activeScripts.postingFixes = false;

         if (getStorage("MissingE_betterReblogs_enabled",1) == 1) {
            activeScripts.betterReblogs = true;
            activeScripts.betterReblogs_fill = true;
         }
         else
            activeScripts.betterReblogs = false;
      }
      if (/http:\/\/www\.tumblr\.com\/dashboard\/iframe/.test(request.message.url) &&
          !(/http:\/\/www\.tumblr\.com\/edit\/[0-9]+/.test(request.message.url)) &&
          !(/http:\/\/www\.tumblr\.com\/tumblelog\/[A-Za-z0-9\-\_]+\/new\//.test(request.message.url)) &&
          !(/http:\/\/www\.tumblr\.com\/new\//.test(request.message.url))) {
         if (getStorage("MissingE_gotoDashPost_enabled",1) == 1) {
            activeScripts.gotoDashPost = true;
         }
         else
            activeScripts.gotoDashPost = false;

         if (getStorage("MissingE_reblogYourself_enabled",1) == 1 &&
             getStorage("MissingE_reblogYourself_postPage",1) == 1) {
            activeScripts.reblogYourself = true;
         }
         else
            activeScripts.reblogYourself = false;
         
         if (getStorage("MissingE_betterReblogs_enabled",1) == 1 &&
             getStorage("MissingE_betterReblogs_passTags",1) == 1) {
            activeScripts.betterReblogs = true;
         }
         else
            activeScripts.betterReblogs = false;
      }
      if (!request.message.isFrame &&
          (/http:\/\/www\.tumblr\.com\/dashboard/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/tumblelog/.test(request.message.url))) {
         if (getStorage("MissingE_replyReplies_enabled",1) == 1) {
            activeScripts.replyReplies = true;
            activeScripts.replyReplies_fill = false;
         }
         else
            activeScripts.replyReplies = false;
      }
      if (!request.message.isFrame &&
          /http:\/\/www\.tumblr\.com\/new\/(text|photo)/.test(request.message.url)) {
         if (getStorage("MissingE_replyReplies_enabled",1) == 1) {
            activeScripts.replyReplies = true;
            activeScripts.replyReplies_fill = true;
         }
         else
            activeScripts.replyReplies = false;
      }
      if (!request.message.isFrame &&
          /http:\/\/www\.tumblr\.com\/following/.test(request.message.url)) {
         if (getStorage("MissingE_postCrushes_enabled",1) == 1) {
            activeScripts.postCrushes = true;
            activeScripts.postCrushes_fill = false;
         }
         else
            activeScripts.postCrushes = false;
      }
      if (!request.message.isFrame &&
          /http:\/\/www\.tumblr\.com\/new\/photo/.test(request.message.url)) {
         if (getStorage("MissingE_postCrushes_enabled",1) == 1) {
            activeScripts.postCrushes = true;
            activeScripts.postCrushes_fill = true;
         }
         else
            activeScripts.postCrushes = false;
      }
      if (!request.message.isFrame &&
          (/http:\/\/www\.tumblr\.com\/dashboard/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/tumblelog/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/likes/.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/liked\/by\//.test(request.message.url) ||
          /http:\/\/www\.tumblr\.com\/tagged\//.test(request.message.url)) &&
          !(/http:\/\/www\.tumblr\.com\/tumblelog\/[^\/]*\/(submissions|messages|drafts|queue)/.test(request.message.url)) &&
          !(/http:\/\/www\.tumblr\.com\/tumblelog\/[^\/]*\/new\//.test(request.message.url))) {
         if (getStorage("MissingE_timestamps_enabled",1) == 1) {
            activeScripts.timestamps = true;
         }
         else
            activeScripts.timestamps = false;

         if (getStorage("MissingE_magnifier_enabled",1) == 1) {
            activeScripts.magnifier = true;
         }
         else
            activeScripts.magnifier = false;

         if (getStorage("MissingE_betterReblogs_enabled",1) == 1) {
            activeScripts.betterReblogs = true;
         }
         else
            activeScripts.betterReblogs = false;

         if (getStorage("MissingE_reblogYourself_enabled",1) == 1 &&
             getStorage("MissingE_reblogYourself_dashboard",1) == 1) {
            activeScripts.reblogYourself = true;
         }
         else
            activeScripts.reblogYourself = false;
      }

      activeScripts.url = request.message.url;
      activeScripts.isFrame = request.message.isFrame;
      request.target.page.dispatchMessage("startup",activeScripts);
   }
}

</script>
</head>
</html>
